{"version":3,"sources":["../../src/endpoints/initiatePayment.ts"],"sourcesContent":["import { addDataAndFileToRequest, type DefaultDocumentIDType, type Endpoint } from 'payload'\n\nimport type {\n  CurrenciesConfig,\n  PaymentAdapter,\n  ProductsValidation,\n  SanitizedEcommercePluginConfig,\n} from '../types/index.js'\n\nimport { defaultProductsValidation } from '../utilities/defaultProductsValidation.js'\n\ntype Args = {\n  /**\n   * The slug of the carts collection, defaults to 'carts'.\n   */\n  cartsSlug?: string\n  currenciesConfig: CurrenciesConfig\n  /**\n   * The slug of the customers collection, defaults to 'users'.\n   */\n  customersSlug?: string\n  /**\n   * Track inventory stock for the products and variants.\n   * Accepts an object to override the default field name.\n   */\n  inventory?: SanitizedEcommercePluginConfig['inventory']\n  paymentMethod: PaymentAdapter\n  /**\n   * The slug of the products collection, defaults to 'products'.\n   */\n  productsSlug?: string\n  /**\n   * Customise the validation used for checking products or variants before a transaction is created.\n   */\n  productsValidation?: ProductsValidation\n  /**\n   * The slug of the transactions collection, defaults to 'transactions'.\n   */\n  transactionsSlug?: string\n  /**\n   * The slug of the variants collection, defaults to 'variants'.\n   */\n  variantsSlug?: string\n}\n\ntype InitiatePayment = (args: Args) => Endpoint['handler']\n\n/**\n * Handles the endpoint for initiating payments. We will handle checking the amount and product and variant prices here before it is sent to the payment provider.\n * This is the first step in the payment process.\n */\nexport const initiatePaymentHandler: InitiatePayment =\n  ({\n    cartsSlug = 'carts',\n    currenciesConfig,\n    customersSlug = 'users',\n    paymentMethod,\n    productsSlug = 'products',\n    productsValidation,\n    transactionsSlug = 'transactions',\n    variantsSlug = 'variants',\n  }) =>\n  async (req) => {\n    await addDataAndFileToRequest(req)\n    const data = req.data\n    const payload = req.payload\n    const user = req.user\n\n    let currency: string = currenciesConfig.defaultCurrency\n    let cartID: DefaultDocumentIDType = data?.cartID\n    let cart = undefined\n    const billingAddress = data?.billingAddress\n    const shippingAddress = data?.shippingAddress\n\n    let customerEmail: string = user?.email ?? ''\n\n    if (user) {\n      if (user.cart?.docs && Array.isArray(user.cart.docs) && user.cart.docs.length > 0) {\n        if (!cartID && user.cart.docs[0]) {\n          // Use the user's cart instead\n          if (typeof user.cart.docs[0] === 'object') {\n            cartID = user.cart.docs[0].id\n            cart = user.cart.docs[0]\n          } else {\n            cartID = user.cart.docs[0]\n          }\n        }\n      }\n    } else {\n      // Get the email from the data if user is not available\n      if (data?.customerEmail && typeof data.customerEmail === 'string') {\n        customerEmail = data.customerEmail\n      } else {\n        return Response.json(\n          {\n            message: 'A customer email is required to make a purchase.',\n          },\n          {\n            status: 400,\n          },\n        )\n      }\n    }\n\n    if (!cart) {\n      if (cartID) {\n        cart = await payload.findByID({\n          id: cartID,\n          collection: cartsSlug,\n          depth: 2,\n          overrideAccess: true,\n          select: {\n            id: true,\n            currency: true,\n            customerEmail: true,\n            items: true,\n            subtotal: true,\n          },\n          user,\n        })\n\n        if (!cart) {\n          return Response.json(\n            {\n              message: `Cart with ID ${cartID} not found.`,\n            },\n            {\n              status: 404,\n            },\n          )\n        }\n      } else {\n        return Response.json(\n          {\n            message: 'Cart ID is required.',\n          },\n          {\n            status: 400,\n          },\n        )\n      }\n    }\n\n    if (cart.currency && typeof cart.currency === 'string') {\n      currency = cart.currency\n    }\n\n    // Ensure the currency is provided or inferred in some way\n    if (!currency) {\n      return Response.json(\n        {\n          message: 'Currency is required.',\n        },\n        {\n          status: 400,\n        },\n      )\n    }\n\n    // Ensure the selected currency is supported\n    if (\n      !currenciesConfig.supportedCurrencies.find(\n        (c) => c.code.toLocaleLowerCase() === currency.toLocaleLowerCase(),\n      )\n    ) {\n      return Response.json(\n        {\n          message: `Currency ${currency} is not supported.`,\n        },\n        {\n          status: 400,\n        },\n      )\n    }\n\n    // Verify the cart is available and items are present in an array\n    if (!cart || !cart.items || !Array.isArray(cart.items) || cart.items.length === 0) {\n      return Response.json(\n        {\n          message: 'Cart is required and must contain at least one item.',\n        },\n        {\n          status: 400,\n        },\n      )\n    }\n\n    for (const item of cart.items) {\n      // Target field to check the price based on the currency so we can validate the total\n      const priceField = `priceIn${currency.toUpperCase()}`\n      const quantity = item.quantity || 1\n\n      // If the item has a product but no variant, we assume the product has a price in the specified currency\n      if (item.product && !item.variant) {\n        const id = typeof item.product === 'object' ? item.product.id : item.product\n\n        const product = await payload.findByID({\n          id,\n          collection: productsSlug,\n          depth: 0,\n          select: {\n            inventory: true,\n            [priceField]: true,\n          },\n        })\n\n        if (!product) {\n          return Response.json(\n            {\n              message: `Product with ID ${item.product} not found.`,\n            },\n            {\n              status: 404,\n            },\n          )\n        }\n\n        try {\n          if (productsValidation) {\n            await productsValidation({ currenciesConfig, currency, product, quantity })\n          } else {\n            await defaultProductsValidation({\n              currenciesConfig,\n              currency,\n              product,\n              quantity,\n            })\n          }\n        } catch (error) {\n          payload.logger.error(\n            error,\n            'Error validating product or variant during payment initiation.',\n          )\n\n          return Response.json(\n            {\n              message: error,\n              ...(error instanceof Error ? { cause: error.cause } : {}),\n            },\n            {\n              status: 400,\n            },\n          )\n        }\n\n        if (item.variant) {\n          const id = typeof item.variant === 'object' ? item.variant.id : item.variant\n\n          const variant = await payload.findByID({\n            id,\n            collection: variantsSlug,\n            depth: 0,\n            select: {\n              inventory: true,\n              [priceField]: true,\n            },\n          })\n\n          if (!variant) {\n            return Response.json(\n              {\n                message: `Variant with ID ${item.variant} not found.`,\n              },\n              {\n                status: 404,\n              },\n            )\n          }\n\n          try {\n            if (productsValidation) {\n              await productsValidation({\n                currenciesConfig,\n                currency,\n                product: item.product,\n                quantity,\n                variant,\n              })\n            } else {\n              await defaultProductsValidation({\n                currenciesConfig,\n                currency,\n                product: item.product,\n                quantity,\n                variant,\n              })\n            }\n          } catch (error) {\n            payload.logger.error(\n              error,\n              'Error validating product or variant during payment initiation.',\n            )\n\n            return Response.json(\n              {\n                message: error,\n              },\n              {\n                status: 400,\n              },\n            )\n          }\n        }\n      }\n    }\n\n    try {\n      const paymentResponse = await paymentMethod.initiatePayment({\n        customersSlug,\n        data: {\n          billingAddress,\n          cart,\n          currency,\n          customerEmail,\n          shippingAddress,\n        },\n        req,\n        transactionsSlug,\n      })\n\n      return Response.json(paymentResponse)\n    } catch (error) {\n      payload.logger.error(error, 'Error initiating payment.')\n\n      return Response.json(\n        {\n          message: 'Error initiating payment.',\n        },\n        {\n          status: 500,\n        },\n      )\n    }\n  }\n"],"names":["addDataAndFileToRequest","defaultProductsValidation","initiatePaymentHandler","cartsSlug","currenciesConfig","customersSlug","paymentMethod","productsSlug","productsValidation","transactionsSlug","variantsSlug","req","data","payload","user","currency","defaultCurrency","cartID","cart","undefined","billingAddress","shippingAddress","customerEmail","email","docs","Array","isArray","length","id","Response","json","message","status","findByID","collection","depth","overrideAccess","select","items","subtotal","supportedCurrencies","find","c","code","toLocaleLowerCase","item","priceField","toUpperCase","quantity","product","variant","inventory","error","logger","Error","cause","paymentResponse","initiatePayment"],"mappings":"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"}