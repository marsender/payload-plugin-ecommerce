{"version":3,"sources":["../../src/endpoints/initiatePayment.ts"],"sourcesContent":["import { addDataAndFileToRequest, type DefaultDocumentIDType, type Endpoint } from 'payload'\n\nimport type { CurrenciesConfig, PaymentAdapter, ProductsValidation, SanitizedEcommercePluginConfig } from '../types/index.js'\n\nimport { defaultProductsValidation } from '../utilities/defaultProductsValidation.js'\n\ntype Args = {\n\t/**\n\t * The slug of the carts collection, defaults to 'carts'.\n\t */\n\tcartsSlug?: string\n\tcurrenciesConfig: CurrenciesConfig\n\t/**\n\t * The slug of the customers collection, defaults to 'users'.\n\t */\n\tcustomersSlug?: string\n\t/**\n\t * Track inventory stock for the products and variants.\n\t * Accepts an object to override the default field name.\n\t */\n\tinventory?: SanitizedEcommercePluginConfig['inventory']\n\tpaymentMethod: PaymentAdapter\n\t/**\n\t * The slug of the products collection, defaults to 'products'.\n\t */\n\tproductsSlug?: string\n\t/**\n\t * Customise the validation used for checking products or variants before a transaction is created.\n\t */\n\tproductsValidation?: ProductsValidation\n\t/**\n\t * The slug of the transactions collection, defaults to 'transactions'.\n\t */\n\ttransactionsSlug?: string\n\t/**\n\t * The slug of the variants collection, defaults to 'variants'.\n\t */\n\tvariantsSlug?: string\n}\n\ntype InitiatePayment = (args: Args) => Endpoint['handler']\n\n/**\n * Handles the endpoint for initiating payments. We will handle checking the amount and product and variant prices here before it is sent to the payment provider.\n * This is the first step in the payment process.\n */\nexport const initiatePaymentHandler: InitiatePayment =\n\t({ cartsSlug = 'carts', currenciesConfig, customersSlug = 'users', paymentMethod, productsSlug = 'products', productsValidation, transactionsSlug = 'transactions', variantsSlug = 'variants' }) =>\n\tasync (req) => {\n\t\tawait addDataAndFileToRequest(req)\n\t\tconst data = req.data\n\t\tconst payload = req.payload\n\t\tconst user = req.user\n\n\t\tlet currency: string = currenciesConfig.defaultCurrency\n\t\tlet cartID: DefaultDocumentIDType = data?.cartID\n\t\tlet cart = undefined\n\t\tconst billingAddress = data?.billingAddress\n\t\tconst shippingAddress = data?.shippingAddress\n\n\t\tlet customerEmail: string = user?.email ?? ''\n\n\t\tif (user) {\n\t\t\tif (user.cart?.docs && Array.isArray(user.cart.docs) && user.cart.docs.length > 0) {\n\t\t\t\tif (!cartID && user.cart.docs[0]) {\n\t\t\t\t\t// Use the user's cart instead\n\t\t\t\t\tif (typeof user.cart.docs[0] === 'object') {\n\t\t\t\t\t\tcartID = user.cart.docs[0].id\n\t\t\t\t\t\tcart = user.cart.docs[0]\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcartID = user.cart.docs[0]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// Get the email from the data if user is not available\n\t\t\tif (data?.customerEmail && typeof data.customerEmail === 'string') {\n\t\t\t\tcustomerEmail = data.customerEmail\n\t\t\t} else {\n\t\t\t\treturn Response.json(\n\t\t\t\t\t{\n\t\t\t\t\t\tmessage: 'A customer email is required to make a purchase.',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tstatus: 400,\n\t\t\t\t\t}\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\n\t\tif (!cart) {\n\t\t\tif (cartID) {\n\t\t\t\tcart = await payload.findByID({\n\t\t\t\t\tid: cartID,\n\t\t\t\t\tcollection: cartsSlug,\n\t\t\t\t\tdepth: 2,\n\t\t\t\t\toverrideAccess: false,\n\t\t\t\t\tselect: {\n\t\t\t\t\t\tid: true,\n\t\t\t\t\t\tcurrency: true,\n\t\t\t\t\t\tcustomerEmail: true,\n\t\t\t\t\t\titems: true,\n\t\t\t\t\t\tsubtotal: true,\n\t\t\t\t\t},\n\t\t\t\t\tuser,\n\t\t\t\t})\n\n\t\t\t\tif (!cart) {\n\t\t\t\t\treturn Response.json(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmessage: `Cart with ID ${cartID} not found.`,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstatus: 404,\n\t\t\t\t\t\t}\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn Response.json(\n\t\t\t\t\t{\n\t\t\t\t\t\tmessage: 'Cart ID is required.',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tstatus: 400,\n\t\t\t\t\t}\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\n\t\tif (cart.currency && typeof cart.currency === 'string') {\n\t\t\tcurrency = cart.currency\n\t\t}\n\n\t\t// Ensure the currency is provided or inferred in some way\n\t\tif (!currency) {\n\t\t\treturn Response.json(\n\t\t\t\t{\n\t\t\t\t\tmessage: 'Currency is required.',\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tstatus: 400,\n\t\t\t\t}\n\t\t\t)\n\t\t}\n\n\t\t// Ensure the selected currency is supported\n\t\tif (!currenciesConfig.supportedCurrencies.find((c) => c.code.toLocaleLowerCase() === currency.toLocaleLowerCase())) {\n\t\t\treturn Response.json(\n\t\t\t\t{\n\t\t\t\t\tmessage: `Currency ${currency} is not supported.`,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tstatus: 400,\n\t\t\t\t}\n\t\t\t)\n\t\t}\n\n\t\t// Verify the cart is available and items are present in an array\n\t\tif (!cart || !cart.items || !Array.isArray(cart.items) || cart.items.length === 0) {\n\t\t\treturn Response.json(\n\t\t\t\t{\n\t\t\t\t\tmessage: 'Cart is required and must contain at least one item.',\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tstatus: 400,\n\t\t\t\t}\n\t\t\t)\n\t\t}\n\n\t\tfor (const item of cart.items) {\n\t\t\t// Target field to check the price based on the currency so we can validate the total\n\t\t\tconst priceField = `priceIn${currency.toUpperCase()}`\n\t\t\tconst quantity = item.quantity || 1\n\n\t\t\t// If the item has a product but no variant, we assume the product has a price in the specified currency\n\t\t\tif (item.product && !item.variant) {\n\t\t\t\tconst id = typeof item.product === 'object' ? item.product.id : item.product\n\n\t\t\t\tconst product = await payload.findByID({\n\t\t\t\t\tid,\n\t\t\t\t\tcollection: productsSlug,\n\t\t\t\t\tdepth: 0,\n\t\t\t\t\tselect: {\n\t\t\t\t\t\tinventory: true,\n\t\t\t\t\t\t[priceField]: true,\n\t\t\t\t\t},\n\t\t\t\t})\n\n\t\t\t\tif (!product) {\n\t\t\t\t\treturn Response.json(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmessage: `Product with ID ${item.product} not found.`,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstatus: 404,\n\t\t\t\t\t\t}\n\t\t\t\t\t)\n\t\t\t\t}\n\n\t\t\t\ttry {\n\t\t\t\t\tif (productsValidation) {\n\t\t\t\t\t\tawait productsValidation({ currenciesConfig, currency, product, quantity })\n\t\t\t\t\t} else {\n\t\t\t\t\t\tawait defaultProductsValidation({\n\t\t\t\t\t\t\tcurrenciesConfig,\n\t\t\t\t\t\t\tcurrency,\n\t\t\t\t\t\t\tproduct,\n\t\t\t\t\t\t\tquantity,\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tpayload.logger.error(error, 'Error validating product or variant during payment initiation.')\n\n\t\t\t\t\treturn Response.json(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmessage: error,\n\t\t\t\t\t\t\t...(error instanceof Error ? { cause: error.cause } : {}),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstatus: 400,\n\t\t\t\t\t\t}\n\t\t\t\t\t)\n\t\t\t\t}\n\n\t\t\t\tif (item.variant) {\n\t\t\t\t\tconst id = typeof item.variant === 'object' ? item.variant.id : item.variant\n\n\t\t\t\t\tconst variant = await payload.findByID({\n\t\t\t\t\t\tid,\n\t\t\t\t\t\tcollection: variantsSlug,\n\t\t\t\t\t\tdepth: 0,\n\t\t\t\t\t\tselect: {\n\t\t\t\t\t\t\tinventory: true,\n\t\t\t\t\t\t\t[priceField]: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t})\n\n\t\t\t\t\tif (!variant) {\n\t\t\t\t\t\treturn Response.json(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tmessage: `Variant with ID ${item.variant} not found.`,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tstatus: 404,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t)\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tif (productsValidation) {\n\t\t\t\t\t\t\tawait productsValidation({\n\t\t\t\t\t\t\t\tcurrenciesConfig,\n\t\t\t\t\t\t\t\tcurrency,\n\t\t\t\t\t\t\t\tproduct: item.product,\n\t\t\t\t\t\t\t\tquantity,\n\t\t\t\t\t\t\t\tvariant,\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tawait defaultProductsValidation({\n\t\t\t\t\t\t\t\tcurrenciesConfig,\n\t\t\t\t\t\t\t\tcurrency,\n\t\t\t\t\t\t\t\tproduct: item.product,\n\t\t\t\t\t\t\t\tquantity,\n\t\t\t\t\t\t\t\tvariant,\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tpayload.logger.error(error, 'Error validating product or variant during payment initiation.')\n\n\t\t\t\t\t\treturn Response.json(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tmessage: error,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tstatus: 400,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\tconst paymentResponse = await paymentMethod.initiatePayment({\n\t\t\t\tcustomersSlug,\n\t\t\t\tdata: {\n\t\t\t\t\tbillingAddress,\n\t\t\t\t\tcart,\n\t\t\t\t\tcurrency,\n\t\t\t\t\tcustomerEmail,\n\t\t\t\t\tshippingAddress,\n\t\t\t\t},\n\t\t\t\treq,\n\t\t\t\ttransactionsSlug,\n\t\t\t})\n\n\t\t\treturn Response.json(paymentResponse)\n\t\t} catch (error) {\n\t\t\tpayload.logger.error(error, 'Error initiating payment.')\n\n\t\t\treturn Response.json(\n\t\t\t\t{\n\t\t\t\t\tmessage: 'Error initiating payment.',\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tstatus: 500,\n\t\t\t\t}\n\t\t\t)\n\t\t}\n\t}\n"],"names":["addDataAndFileToRequest","defaultProductsValidation","initiatePaymentHandler","cartsSlug","currenciesConfig","customersSlug","paymentMethod","productsSlug","productsValidation","transactionsSlug","variantsSlug","req","data","payload","user","currency","defaultCurrency","cartID","cart","undefined","billingAddress","shippingAddress","customerEmail","email","docs","Array","isArray","length","id","Response","json","message","status","findByID","collection","depth","overrideAccess","select","items","subtotal","supportedCurrencies","find","c","code","toLocaleLowerCase","item","priceField","toUpperCase","quantity","product","variant","inventory","error","logger","Error","cause","paymentResponse","initiatePayment"],"mappings":"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"}