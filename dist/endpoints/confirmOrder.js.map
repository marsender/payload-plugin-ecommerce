{"version":3,"sources":["../../src/endpoints/confirmOrder.ts"],"sourcesContent":["import { addDataAndFileToRequest, type DefaultDocumentIDType, type Endpoint } from 'payload'\n\nimport type { CurrenciesConfig, PaymentAdapter, ProductsValidation } from '../types/index.js'\n\ntype Args = {\n\t/**\n\t * The slug of the carts collection, defaults to 'carts'.\n\t */\n\tcartsSlug?: string\n\tcurrenciesConfig: CurrenciesConfig\n\t/**\n\t * The slug of the customers collection, defaults to 'users'.\n\t */\n\tcustomersSlug?: string\n\t/**\n\t * The slug of the orders collection, defaults to 'orders'.\n\t */\n\tordersSlug?: string\n\tpaymentMethod: PaymentAdapter\n\t/**\n\t * The slug of the products collection, defaults to 'products'.\n\t */\n\tproductsSlug?: string\n\t/**\n\t * Customise the validation used for checking products or variants before a transaction is created.\n\t */\n\tproductsValidation?: ProductsValidation\n\t/**\n\t * The slug of the transactions collection, defaults to 'transactions'.\n\t */\n\ttransactionsSlug?: string\n\t/**\n\t * The slug of the variants collection, defaults to 'variants'.\n\t */\n\tvariantsSlug?: string\n}\n\ntype ConfirmOrderHandler = (args: Args) => Endpoint['handler']\n\n/**\n * Handles the endpoint for initiating payments. We will handle checking the amount and product and variant prices here before it is sent to the payment provider.\n * This is the first step in the payment process.\n */\nexport const confirmOrderHandler: ConfirmOrderHandler =\n\t({ cartsSlug = 'carts', currenciesConfig, customersSlug = 'users', ordersSlug = 'orders', paymentMethod, productsSlug = 'products', productsValidation, transactionsSlug = 'transactions', variantsSlug = 'variants' }) =>\n\tasync (req) => {\n\t\tawait addDataAndFileToRequest(req)\n\n\t\tconst data = req.data\n\t\tconst payload = req.payload\n\t\tconst user = req.user\n\n\t\tlet currency: string = currenciesConfig.defaultCurrency\n\t\tlet cartID: DefaultDocumentIDType = data?.cartID\n\t\tlet cart = undefined\n\t\tlet customerEmail: string = user?.email ?? ''\n\n\t\tif (user) {\n\t\t\tif (user.cart?.docs && Array.isArray(user.cart.docs) && user.cart.docs.length > 0) {\n\t\t\t\tif (!cartID && user.cart.docs[0]) {\n\t\t\t\t\t// Use the user's cart instead\n\t\t\t\t\tif (typeof user.cart.docs[0] === 'object') {\n\t\t\t\t\t\tcartID = user.cart.docs[0].id\n\t\t\t\t\t\tcart = user.cart.docs[0]\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcartID = user.cart.docs[0]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// Get the email from the data if user is not available\n\t\t\tif (data?.customerEmail && typeof data.customerEmail === 'string') {\n\t\t\t\tcustomerEmail = data.customerEmail\n\t\t\t} else {\n\t\t\t\treturn Response.json(\n\t\t\t\t\t{\n\t\t\t\t\t\tmessage: 'A customer email is required to make a purchase.',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tstatus: 400,\n\t\t\t\t\t}\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\n\t\tif (!cart) {\n\t\t\tif (cartID) {\n\t\t\t\tcart = await payload.findByID({\n\t\t\t\t\tid: cartID,\n\t\t\t\t\tcollection: cartsSlug,\n\t\t\t\t\tdepth: 2,\n\t\t\t\t\toverrideAccess: false,\n\t\t\t\t\tselect: {\n\t\t\t\t\t\tid: true,\n\t\t\t\t\t\tcurrency: true,\n\t\t\t\t\t\tcustomerEmail: true,\n\t\t\t\t\t\titems: true,\n\t\t\t\t\t\tsubtotal: true,\n\t\t\t\t\t},\n\t\t\t\t\tuser,\n\t\t\t\t})\n\n\t\t\t\tif (!cart) {\n\t\t\t\t\treturn Response.json(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmessage: `Cart with ID ${cartID} not found.`,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstatus: 404,\n\t\t\t\t\t\t}\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn Response.json(\n\t\t\t\t\t{\n\t\t\t\t\t\tmessage: 'Cart ID is required.',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tstatus: 400,\n\t\t\t\t\t}\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\n\t\tif (cart.currency && typeof cart.currency === 'string') {\n\t\t\tcurrency = cart.currency\n\t\t}\n\n\t\t// Ensure the currency is provided or inferred in some way\n\t\tif (!currency) {\n\t\t\treturn Response.json(\n\t\t\t\t{\n\t\t\t\t\tmessage: 'Currency is required.',\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tstatus: 400,\n\t\t\t\t}\n\t\t\t)\n\t\t}\n\n\t\ttry {\n\t\t\tconst paymentResponse = await paymentMethod.confirmOrder({\n\t\t\t\tcustomersSlug,\n\t\t\t\tdata: {\n\t\t\t\t\t...data,\n\t\t\t\t\tcustomerEmail,\n\t\t\t\t},\n\t\t\t\tordersSlug,\n\t\t\t\treq,\n\t\t\t\ttransactionsSlug,\n\t\t\t})\n\n\t\t\tif (paymentResponse.transactionID) {\n\t\t\t\tconst transaction = await payload.findByID({\n\t\t\t\t\tid: paymentResponse.transactionID,\n\t\t\t\t\tcollection: transactionsSlug,\n\t\t\t\t\tdepth: 0,\n\t\t\t\t\tselect: {\n\t\t\t\t\t\tid: true,\n\t\t\t\t\t\titems: true,\n\t\t\t\t\t},\n\t\t\t\t})\n\n\t\t\t\tif (transaction && Array.isArray(transaction.items) && transaction.items.length > 0) {\n\t\t\t\t\tfor (const item of transaction.items) {\n\t\t\t\t\t\tif (item.variant) {\n\t\t\t\t\t\t\tconst id = typeof item.variant === 'object' ? item.variant.id : item.variant\n\n\t\t\t\t\t\t\tawait payload.db.updateOne({\n\t\t\t\t\t\t\t\tid,\n\t\t\t\t\t\t\t\tcollection: variantsSlug,\n\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\tinventory: {\n\t\t\t\t\t\t\t\t\t\t$inc: item.quantity * -1,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t} else if (item.product) {\n\t\t\t\t\t\t\tconst id = typeof item.product === 'object' ? item.product.id : item.product\n\n\t\t\t\t\t\t\tawait payload.db.updateOne({\n\t\t\t\t\t\t\t\tid,\n\t\t\t\t\t\t\t\tcollection: productsSlug,\n\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\tinventory: {\n\t\t\t\t\t\t\t\t\t\t$inc: item.quantity * -1,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ('paymentResponse.transactionID' in paymentResponse && paymentResponse.transactionID) {\n\t\t\t\tdelete (paymentResponse as Partial<typeof paymentResponse>).transactionID\n\t\t\t}\n\n\t\t\treturn Response.json(paymentResponse)\n\t\t} catch (error) {\n\t\t\tpayload.logger.error(error, 'Error confirming order.')\n\n\t\t\treturn Response.json(\n\t\t\t\t{\n\t\t\t\t\tmessage: 'Error confirming order.',\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tstatus: 500,\n\t\t\t\t}\n\t\t\t)\n\t\t}\n\t}\n"],"names":["addDataAndFileToRequest","confirmOrderHandler","cartsSlug","currenciesConfig","customersSlug","ordersSlug","paymentMethod","productsSlug","productsValidation","transactionsSlug","variantsSlug","req","data","payload","user","currency","defaultCurrency","cartID","cart","undefined","customerEmail","email","docs","Array","isArray","length","id","Response","json","message","status","findByID","collection","depth","overrideAccess","select","items","subtotal","paymentResponse","confirmOrder","transactionID","transaction","item","variant","db","updateOne","inventory","$inc","quantity","product","error","logger"],"mappings":"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"}