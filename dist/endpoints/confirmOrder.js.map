{"version":3,"sources":["../../src/endpoints/confirmOrder.ts"],"sourcesContent":["import { addDataAndFileToRequest, type DefaultDocumentIDType, type Endpoint } from 'payload'\n\nimport type { CurrenciesConfig, PaymentAdapter, ProductsValidation } from '../types/index.js'\n\ntype Args = {\n  /**\n   * The slug of the carts collection, defaults to 'carts'.\n   */\n  cartsSlug?: string\n  currenciesConfig: CurrenciesConfig\n  /**\n   * The slug of the customers collection, defaults to 'users'.\n   */\n  customersSlug?: string\n  /**\n   * The slug of the orders collection, defaults to 'orders'.\n   */\n  ordersSlug?: string\n  paymentMethod: PaymentAdapter\n  /**\n   * The slug of the products collection, defaults to 'products'.\n   */\n  productsSlug?: string\n  /**\n   * Customise the validation used for checking products or variants before a transaction is created.\n   */\n  productsValidation?: ProductsValidation\n  /**\n   * The slug of the transactions collection, defaults to 'transactions'.\n   */\n  transactionsSlug?: string\n  /**\n   * The slug of the variants collection, defaults to 'variants'.\n   */\n  variantsSlug?: string\n}\n\ntype ConfirmOrderHandler = (args: Args) => Endpoint['handler']\n\n/**\n * Handles the endpoint for initiating payments. We will handle checking the amount and product and variant prices here before it is sent to the payment provider.\n * This is the first step in the payment process.\n */\nexport const confirmOrderHandler: ConfirmOrderHandler =\n  ({\n    cartsSlug = 'carts',\n    currenciesConfig,\n    customersSlug = 'users',\n    ordersSlug = 'orders',\n    paymentMethod,\n    productsSlug = 'products',\n    productsValidation,\n    transactionsSlug = 'transactions',\n    variantsSlug = 'variants',\n  }) =>\n  async (req) => {\n    await addDataAndFileToRequest(req)\n\n    const data = req.data\n    const payload = req.payload\n    const user = req.user\n\n    let currency: string = currenciesConfig.defaultCurrency\n    let cartID: DefaultDocumentIDType = data?.cartID\n    let cart = undefined\n    let customerEmail: string = user?.email ?? ''\n\n    if (user) {\n      if (user.cart?.docs && Array.isArray(user.cart.docs) && user.cart.docs.length > 0) {\n        if (!cartID && user.cart.docs[0]) {\n          // Use the user's cart instead\n          if (typeof user.cart.docs[0] === 'object') {\n            cartID = user.cart.docs[0].id\n            cart = user.cart.docs[0]\n          } else {\n            cartID = user.cart.docs[0]\n          }\n        }\n      }\n    } else {\n      // Get the email from the data if user is not available\n      if (data?.customerEmail && typeof data.customerEmail === 'string') {\n        customerEmail = data.customerEmail\n      } else {\n        return Response.json(\n          {\n            message: 'A customer email is required to make a purchase.',\n          },\n          {\n            status: 400,\n          },\n        )\n      }\n    }\n\n    if (!cart) {\n      if (cartID) {\n        cart = await payload.findByID({\n          id: cartID,\n          collection: cartsSlug,\n          depth: 2,\n          overrideAccess: false,\n          select: {\n            id: true,\n            currency: true,\n            customerEmail: true,\n            items: true,\n            subtotal: true,\n          },\n          user,\n        })\n\n        if (!cart) {\n          return Response.json(\n            {\n              message: `Cart with ID ${cartID} not found.`,\n            },\n            {\n              status: 404,\n            },\n          )\n        }\n      } else {\n        return Response.json(\n          {\n            message: 'Cart ID is required.',\n          },\n          {\n            status: 400,\n          },\n        )\n      }\n    }\n\n    if (cart.currency && typeof cart.currency === 'string') {\n      currency = cart.currency\n    }\n\n    // Ensure the currency is provided or inferred in some way\n    if (!currency) {\n      return Response.json(\n        {\n          message: 'Currency is required.',\n        },\n        {\n          status: 400,\n        },\n      )\n    }\n\n    try {\n      const paymentResponse = await paymentMethod.confirmOrder({\n        customersSlug,\n        data: {\n          ...data,\n          customerEmail,\n        },\n        ordersSlug,\n        req,\n        transactionsSlug,\n      })\n\n      if (paymentResponse.transactionID) {\n        const transaction = await payload.findByID({\n          id: paymentResponse.transactionID,\n          collection: transactionsSlug,\n          depth: 0,\n          select: {\n            id: true,\n            items: true,\n          },\n        })\n\n        if (transaction && Array.isArray(transaction.items) && transaction.items.length > 0) {\n          for (const item of transaction.items) {\n            if (item.variant) {\n              const id = typeof item.variant === 'object' ? item.variant.id : item.variant\n\n              await payload.db.updateOne({\n                id,\n                collection: variantsSlug,\n                data: {\n                  inventory: {\n                    $inc: item.quantity * -1,\n                  },\n                },\n              })\n            } else if (item.product) {\n              const id = typeof item.product === 'object' ? item.product.id : item.product\n\n              await payload.db.updateOne({\n                id,\n                collection: productsSlug,\n                data: {\n                  inventory: {\n                    $inc: item.quantity * -1,\n                  },\n                },\n              })\n            }\n          }\n        }\n      }\n\n      if ('paymentResponse.transactionID' in paymentResponse && paymentResponse.transactionID) {\n        delete (paymentResponse as Partial<typeof paymentResponse>).transactionID\n      }\n\n      return Response.json(paymentResponse)\n    } catch (error) {\n      payload.logger.error(error, 'Error confirming order.')\n\n      return Response.json(\n        {\n          message: 'Error confirming order.',\n        },\n        {\n          status: 500,\n        },\n      )\n    }\n  }\n"],"names":["addDataAndFileToRequest","confirmOrderHandler","cartsSlug","currenciesConfig","customersSlug","ordersSlug","paymentMethod","productsSlug","productsValidation","transactionsSlug","variantsSlug","req","data","payload","user","currency","defaultCurrency","cartID","cart","undefined","customerEmail","email","docs","Array","isArray","length","id","Response","json","message","status","findByID","collection","depth","overrideAccess","select","items","subtotal","paymentResponse","confirmOrder","transactionID","transaction","item","variant","db","updateOne","inventory","$inc","quantity","product","error","logger"],"mappings":"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"}