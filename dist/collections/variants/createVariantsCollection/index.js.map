{"version":3,"sources":["../../../../src/collections/variants/createVariantsCollection/index.ts"],"sourcesContent":["import type { CollectionConfig, Field } from 'payload'\n\nimport type { AccessConfig, CurrenciesConfig, InventoryConfig } from '../../../types/index.js'\n\nimport { inventoryField } from '../../../fields/inventoryField.js'\nimport { pricesField } from '../../../fields/pricesField.js'\nimport { populateTenant } from '../../../utilities/populateTenant.js'\nimport { tenantBaseListFilter } from '../../../utilities/tenantBaseListFilter.js'\nimport { hasTenantAccess } from '../../carts/cartTenantAccess.js'\nimport { variantsCollectionBeforeChange as beforeChange } from './hooks/beforeChange.js'\nimport { validateOptions } from './hooks/validateOptions.js'\n\ntype Props = {\n  access: Pick<AccessConfig, 'adminOrPublishedStatus' | 'isAdmin'>\n  currenciesConfig?: CurrenciesConfig\n  /**\n   * Enables inventory tracking for variants. Defaults to true.\n   */\n  inventory?: boolean | InventoryConfig\n  /**\n   * Multi-tenant configuration for variants.\n   * When enabled, variants will have a tenant field and access will be scoped by tenant for admins.\n   */\n  multiTenant?: {\n    enabled: boolean\n    tenantsSlug?: string\n  }\n  /**\n   * Slug of the products collection, defaults to 'products'.\n   */\n  productsSlug?: string\n  /**\n   * Slug of the variant options collection, defaults to 'variantOptions'.\n   */\n  variantOptionsSlug?: string\n  /**\n   * Slug of the variant types collection, defaults to 'variantTypes'.\n   */\n  variantTypesSlug?: string\n}\n\nexport const createVariantsCollection: (props: Props) => CollectionConfig = (props) => {\n  const {\n    access,\n    currenciesConfig,\n    inventory = true,\n    multiTenant,\n    productsSlug = 'products',\n    variantOptionsSlug = 'variantOptions',\n    variantTypesSlug = 'variantTypes',\n  } = props || {}\n  const { supportedCurrencies } = currenciesConfig || {}\n\n  const tenantsSlug = multiTenant?.tenantsSlug || 'tenants'\n\n  const fields: Field[] = [\n    // Tenant field (only added when multiTenant is enabled)\n    ...(multiTenant?.enabled\n      ? [\n          {\n            name: 'tenant',\n            type: 'relationship',\n            admin: {\n              position: 'sidebar',\n              readOnly: true,\n            },\n            index: true,\n            label: ({ t }: { t: (key: string) => string }) =>\n              t('plugin-ecommerce:tenant') || 'Tenant',\n            relationTo: tenantsSlug,\n            required: false,\n          } as Field,\n        ]\n      : []),\n    {\n      name: 'title',\n      type: 'text',\n      admin: {\n        description:\n          'Used for administrative purposes, not shown to customers. This is populated by default.',\n      },\n    },\n    {\n      name: 'product',\n      type: 'relationship',\n      admin: {\n        position: 'sidebar',\n        readOnly: true,\n      },\n      relationTo: productsSlug,\n      required: true,\n    },\n    {\n      // This might need to be a custom component, to show a selector for each variant that is\n      // enabled on the parent product\n      // - separate select inputs, each showing only a specific variant (w/ options)\n      // - it will save data to the DB as IDs in this relationship field\n      // and needs a validate function as well which enforces that the options are fully specified, and accurate\n      name: 'options',\n      type: 'relationship',\n      admin: {\n        components: {\n          Field: {\n            path: '@marsender/payload-plugin-ecommerce/rsc#VariantOptionsSelector',\n          },\n        },\n      },\n      custom: {\n        productsSlug,\n        variantTypesSlug,\n      },\n      hasMany: true,\n      label: 'Variant options',\n      relationTo: variantOptionsSlug,\n      required: true,\n      validate: validateOptions({ productsCollectionSlug: productsSlug }),\n    },\n    ...(inventory ? [inventoryField()] : []),\n  ]\n\n  if (supportedCurrencies?.length && supportedCurrencies.length > 0) {\n    const currencyOptions: string[] = []\n\n    supportedCurrencies.forEach((currency) => {\n      currencyOptions.push(currency.code)\n    })\n\n    if (currenciesConfig) {\n      fields.push(...pricesField({ currenciesConfig }))\n    }\n  }\n\n  // Admin access: when multiTenant is enabled, use tenant-scoped access; otherwise use isAdmin\n  const adminAccess = multiTenant?.enabled\n    ? hasTenantAccess({ isAdmin: access.isAdmin })\n    : access.isAdmin\n\n  const baseConfig: CollectionConfig = {\n    slug: 'variants',\n    access: {\n      create: adminAccess,\n      delete: adminAccess,\n      read: access.adminOrPublishedStatus,\n      update: adminAccess,\n    },\n    admin: {\n      description: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:variantsCollectionDescription'),\n      group: false,\n      useAsTitle: 'title',\n      ...(multiTenant?.enabled && {\n        baseListFilter: tenantBaseListFilter(),\n      }),\n    },\n    fields,\n    hooks: {\n      beforeChange: [\n        ...(multiTenant?.enabled ? [populateTenant({ tenantsSlug })] : []),\n        beforeChange({ productsSlug, variantOptionsSlug }),\n      ],\n    },\n    labels: {\n      plural: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:variants'),\n      singular: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:variant'),\n    },\n    trash: true,\n    versions: {\n      drafts: {\n        autosave: true,\n      },\n    },\n  }\n\n  return baseConfig\n}\n"],"names":["inventoryField","pricesField","populateTenant","tenantBaseListFilter","hasTenantAccess","variantsCollectionBeforeChange","beforeChange","validateOptions","createVariantsCollection","props","access","currenciesConfig","inventory","multiTenant","productsSlug","variantOptionsSlug","variantTypesSlug","supportedCurrencies","tenantsSlug","fields","enabled","name","type","admin","position","readOnly","index","label","t","relationTo","required","description","components","Field","path","custom","hasMany","validate","productsCollectionSlug","length","currencyOptions","forEach","currency","push","code","adminAccess","isAdmin","baseConfig","slug","create","delete","read","adminOrPublishedStatus","update","group","useAsTitle","baseListFilter","hooks","labels","plural","singular","trash","versions","drafts","autosave"],"mappings":"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"}