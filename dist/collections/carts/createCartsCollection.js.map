{"version":3,"sources":["../../../src/collections/carts/createCartsCollection.ts"],"sourcesContent":["import type { Access, CollectionConfig, Field } from 'payload'\n\nimport type { AccessConfig, CurrenciesConfig } from '../../types/index.js'\nimport type { CartItemMatcher } from './operations/types.js'\n\nimport { amountField } from '../../fields/amountField.js'\nimport { cartItemsField } from '../../fields/cartItemsField.js'\nimport { currencyField } from '../../fields/currencyField.js'\nimport { accessOR, conditional } from '../../utilities/accessComposition.js'\nimport { beforeChangeCart } from './beforeChange.js'\nimport { hasTenantAccess } from './cartTenantAccess.js'\nimport { addItemEndpoint } from './endpoints/addItem.js'\nimport { clearCartEndpoint } from './endpoints/clearCart.js'\nimport { mergeCartEndpoint } from './endpoints/mergeCart.js'\nimport { removeItemEndpoint } from './endpoints/removeItem.js'\nimport { updateItemEndpoint } from './endpoints/updateItem.js'\nimport { hasCartSecretAccess } from './hasCartSecretAccess.js'\nimport { populateTenant } from './populateTenant.js'\nimport { statusBeforeRead } from './statusBeforeRead.js'\nimport { tenantBaseListFilter } from './tenantBaseListFilter.js'\n\ntype Props = {\n  access: Pick<Required<AccessConfig>, 'isAdmin' | 'isAuthenticated' | 'isDocumentOwner'>\n  /**\n   * Allow guest (unauthenticated) users to create carts.\n   * Defaults to false.\n   */\n  allowGuestCarts?: boolean\n  /**\n   * Custom function to determine if two cart items should be considered the same.\n   * When items match, their quantities are combined instead of creating separate entries.\n   *\n   * Use this to add custom uniqueness criteria beyond product and variant IDs.\n   *\n   * @default defaultCartItemMatcher (matches by product and variant ID only)\n   *\n   * @example\n   * ```ts\n   * cartItemMatcher: ({ existingItem, newItem }) => {\n   *   // Match by product, variant, AND custom delivery option\n   *   const productMatch = existingItem.product === newItem.product\n   *   const variantMatch = existingItem.variant === newItem.variant\n   *   const deliveryMatch = existingItem.deliveryOption === newItem.deliveryOption\n   *   return productMatch && variantMatch && deliveryMatch\n   * }\n   * ```\n   */\n  cartItemMatcher?: CartItemMatcher\n  currenciesConfig?: CurrenciesConfig\n  /**\n   * Slug of the customers collection, defaults to 'users'.\n   */\n  customersSlug?: string\n  /**\n   * Enables support for variants in the cart.\n   * Defaults to false.\n   */\n  enableVariants?: boolean\n  /**\n   * Multi-tenant configuration for carts.\n   * When enabled, carts will have a tenant field and access will be scoped by tenant for admins.\n   * Guest access via secret is still supported.\n   */\n  multiTenant?: {\n    /**\n     * Whether multi-tenant support is enabled.\n     */\n    enabled: boolean\n    /**\n     * The slug of the tenants collection.\n     * @default 'tenants'\n     */\n    tenantsSlug?: string\n  }\n  /**\n   * Slug of the products collection, defaults to 'products'.\n   */\n  productsSlug?: string\n  /**\n   * Slug of the variants collection, defaults to 'variants'.\n   */\n  variantsSlug?: string\n}\n\nexport const createCartsCollection: (props: Props) => CollectionConfig = (props) => {\n  const {\n    access,\n    allowGuestCarts = false,\n    cartItemMatcher,\n    currenciesConfig,\n    customersSlug = 'users',\n    enableVariants = false,\n    multiTenant,\n    productsSlug = 'products',\n    variantsSlug = 'variants',\n  } = props || {}\n\n  const tenantsSlug = multiTenant?.tenantsSlug || 'tenants'\n\n  const cartsSlug = 'carts'\n\n  const fields: Field[] = [\n    // Tenant field (only added when multiTenant is enabled)\n    ...(multiTenant?.enabled\n      ? [\n          {\n            name: 'tenant',\n            type: 'relationship',\n            relationTo: tenantsSlug,\n            // Not required - guests create carts without tenant initially\n            required: false,\n            index: true,\n            admin: {\n              position: 'sidebar',\n              // Read-only for everyone - populated automatically by hook\n              readOnly: true,\n            },\n            label: ({ t }) =>\n              // @ts-expect-error - translations are not typed in plugins yet\n              t('plugin-ecommerce:tenant') || 'Tenant',\n          } as Field,\n        ]\n      : []),\n    cartItemsField({\n      enableVariants,\n      overrides: {\n        label: ({ t }) =>\n          // @ts-expect-error - translations are not typed in plugins yet\n          t('plugin-ecommerce:items'),\n        labels: {\n          plural: ({ t }) =>\n            // @ts-expect-error - translations are not typed in plugins yet\n            t('plugin-ecommerce:items'),\n          singular: ({ t }) =>\n            // @ts-expect-error - translations are not typed in plugins yet\n            t('plugin-ecommerce:item'),\n        },\n      },\n      productsSlug,\n      variantsSlug,\n    }),\n    {\n      name: 'secret',\n      type: 'text',\n      access: {\n        create: () => false, // Users can't set it manually\n        read: () => false, // Never readable via field access (only through afterRead hook)\n        update: () => false, // Users can't update it\n      },\n      admin: {\n        hidden: true,\n        position: 'sidebar',\n        readOnly: true,\n      },\n      index: true,\n      label: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:cartSecret'),\n    },\n    {\n      name: 'customer',\n      type: 'relationship',\n      admin: {\n        position: 'sidebar',\n      },\n      label: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:customer'),\n      relationTo: customersSlug,\n    },\n    {\n      name: 'purchasedAt',\n      type: 'date',\n      admin: {\n        date: { pickerAppearance: 'dayAndTime' },\n        position: 'sidebar',\n      },\n      label: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:purchasedAt'),\n    },\n    {\n      name: 'status',\n      type: 'select',\n      admin: {\n        position: 'sidebar',\n        readOnly: true,\n      },\n      hooks: {\n        afterRead: [statusBeforeRead],\n      },\n      label: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:status'),\n      options: [\n        {\n          // @ts-expect-error - translations are not typed in plugins yet\n          label: ({ t }) => t('plugin-ecommerce:active'),\n          value: 'active',\n        },\n        {\n          // @ts-expect-error - translations are not typed in plugins yet\n          label: ({ t }) => t('plugin-ecommerce:purchased'),\n          value: 'purchased',\n        },\n        {\n          // @ts-expect-error - translations are not typed in plugins yet\n          label: ({ t }) => t('plugin-ecommerce:abandoned'),\n          value: 'abandoned',\n        },\n      ],\n      virtual: true,\n    },\n    ...(currenciesConfig\n      ? [\n          {\n            type: 'row',\n            admin: { position: 'sidebar' },\n            fields: [\n              amountField({\n                currenciesConfig,\n                overrides: {\n                  name: 'subtotal',\n\n                  label: ({ t }) =>\n                    // @ts-expect-error - translations are not typed in plugins yet\n                    t('plugin-ecommerce:subtotal'),\n                },\n              }),\n              currencyField({\n                currenciesConfig,\n              }),\n            ],\n          } as Field,\n        ]\n      : []),\n  ]\n\n  // Internal access function for guest users (unauthenticated)\n  const isGuest: Access = ({ req }) => !req.user\n\n  // Admin access: when multiTenant is enabled, use tenant-scoped access; otherwise use isAdmin\n  const adminAccess = multiTenant?.enabled\n    ? hasTenantAccess({ isAdmin: access.isAdmin })\n    : access.isAdmin\n\n  const baseConfig: CollectionConfig = {\n    slug: cartsSlug,\n    access: {\n      create: accessOR(\n        access.isAdmin,\n        access.isAuthenticated,\n        conditional(allowGuestCarts, isGuest),\n      ),\n      delete: accessOR(adminAccess, access.isDocumentOwner, hasCartSecretAccess(allowGuestCarts)),\n      read: accessOR(adminAccess, access.isDocumentOwner, hasCartSecretAccess(allowGuestCarts)),\n      update: accessOR(adminAccess, access.isDocumentOwner, hasCartSecretAccess(allowGuestCarts)),\n    },\n    admin: {\n      description: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:cartsCollectionDescription'),\n      group: 'Ecommerce',\n      useAsTitle: 'createdAt',\n      // Filter list view by tenant when multiTenant is enabled\n      ...(multiTenant?.enabled && {\n        baseListFilter: tenantBaseListFilter(),\n      }),\n    },\n    endpoints: [\n      addItemEndpoint({ cartItemMatcher, cartsSlug }),\n      clearCartEndpoint({ cartsSlug }),\n      // mergeCartEndpoint uses its own matcher that handles CartItemData for both items\n      mergeCartEndpoint({ cartsSlug }),\n      removeItemEndpoint({ cartsSlug }),\n      updateItemEndpoint({ cartsSlug }),\n    ],\n    fields,\n    hooks: {\n      afterRead: [\n        ({ doc, req }) => {\n          // Include secret only if this was just created (stored in context by beforeChange)\n          if (req.context?.newCartSecret) {\n            doc.secret = req.context.newCartSecret\n          }\n          // Secret is otherwise never exposed (field access is locked)\n          return doc\n        },\n      ],\n      beforeChange: [\n        // Populate tenant from cookies when multiTenant is enabled\n        ...(multiTenant?.enabled ? [populateTenant({ tenantsSlug })] : []),\n        // This hook can be used to update the subtotal before saving the cart\n        beforeChangeCart({ productsSlug, variantsSlug }),\n      ],\n    },\n    labels: {\n      plural: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:carts'),\n      singular: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:cart'),\n    },\n    timestamps: true,\n  }\n\n  return { ...baseConfig }\n}\n"],"names":["amountField","cartItemsField","currencyField","accessOR","conditional","beforeChangeCart","hasTenantAccess","addItemEndpoint","clearCartEndpoint","mergeCartEndpoint","removeItemEndpoint","updateItemEndpoint","hasCartSecretAccess","populateTenant","statusBeforeRead","tenantBaseListFilter","createCartsCollection","props","access","allowGuestCarts","cartItemMatcher","currenciesConfig","customersSlug","enableVariants","multiTenant","productsSlug","variantsSlug","tenantsSlug","cartsSlug","fields","enabled","name","type","relationTo","required","index","admin","position","readOnly","label","t","overrides","labels","plural","singular","create","read","update","hidden","date","pickerAppearance","hooks","afterRead","options","value","virtual","isGuest","req","user","adminAccess","isAdmin","baseConfig","slug","isAuthenticated","delete","isDocumentOwner","description","group","useAsTitle","baseListFilter","endpoints","doc","context","newCartSecret","secret","beforeChange","timestamps"],"mappings":"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"}