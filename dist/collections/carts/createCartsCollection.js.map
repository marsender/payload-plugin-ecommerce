{"version":3,"sources":["../../../src/collections/carts/createCartsCollection.ts"],"sourcesContent":["import type { Access, CollectionConfig, Field } from 'payload'\n\nimport type { AccessConfig, CurrenciesConfig } from '../../types/index.js'\n\nimport { amountField } from '../../fields/amountField.js'\nimport { cartItemsField } from '../../fields/cartItemsField.js'\nimport { currencyField } from '../../fields/currencyField.js'\nimport { accessOR, conditional } from '../../utilities/accessComposition.js'\nimport { beforeChangeCart } from './beforeChange.js'\nimport { hasCartSecretAccess } from './hasCartSecretAccess.js'\nimport { statusBeforeRead } from './statusBeforeRead.js'\n\ntype Props = {\n  access: Pick<Required<AccessConfig>, 'isAdmin' | 'isAuthenticated' | 'isDocumentOwner'>\n  /**\n   * Allow guest (unauthenticated) users to create carts.\n   * Defaults to false.\n   */\n  allowGuestCarts?: boolean\n  currenciesConfig?: CurrenciesConfig\n  /**\n   * Slug of the customers collection, defaults to 'users'.\n   */\n  customersSlug?: string\n  /**\n   * Enables support for variants in the cart.\n   * Defaults to false.\n   */\n  enableVariants?: boolean\n  /**\n   * Slug of the products collection, defaults to 'products'.\n   */\n  productsSlug?: string\n  /**\n   * Slug of the variants collection, defaults to 'variants'.\n   */\n  variantsSlug?: string\n}\n\nexport const createCartsCollection: (props: Props) => CollectionConfig = (props) => {\n  const {\n    access,\n    allowGuestCarts = false,\n    currenciesConfig,\n    customersSlug = 'users',\n    enableVariants = false,\n    productsSlug = 'products',\n    variantsSlug = 'variants',\n  } = props || {}\n\n  const fields: Field[] = [\n    cartItemsField({\n      enableVariants,\n      overrides: {\n        label: ({ t }) =>\n          // @ts-expect-error - translations are not typed in plugins yet\n          t('plugin-ecommerce:items'),\n        labels: {\n          plural: ({ t }) =>\n            // @ts-expect-error - translations are not typed in plugins yet\n            t('plugin-ecommerce:items'),\n          singular: ({ t }) =>\n            // @ts-expect-error - translations are not typed in plugins yet\n            t('plugin-ecommerce:item'),\n        },\n      },\n      productsSlug,\n      variantsSlug,\n    }),\n    {\n      name: 'secret',\n      type: 'text',\n      access: {\n        create: () => false, // Users can't set it manually\n        read: () => false, // Never readable via field access (only through afterRead hook)\n        update: () => false, // Users can't update it\n      },\n      admin: {\n        hidden: true,\n        position: 'sidebar',\n        readOnly: true,\n      },\n      index: true,\n      label: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:cartSecret'),\n    },\n    {\n      name: 'customer',\n      type: 'relationship',\n      admin: {\n        position: 'sidebar',\n      },\n      label: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:customer'),\n      relationTo: customersSlug,\n    },\n    {\n      name: 'purchasedAt',\n      type: 'date',\n      admin: {\n        date: { pickerAppearance: 'dayAndTime' },\n        position: 'sidebar',\n      },\n      label: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:purchasedAt'),\n    },\n    {\n      name: 'status',\n      type: 'select',\n      admin: {\n        position: 'sidebar',\n        readOnly: true,\n      },\n      hooks: {\n        afterRead: [statusBeforeRead],\n      },\n      label: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:status'),\n      options: [\n        {\n          // @ts-expect-error - translations are not typed in plugins yet\n          label: ({ t }) => t('plugin-ecommerce:active'),\n          value: 'active',\n        },\n        {\n          // @ts-expect-error - translations are not typed in plugins yet\n          label: ({ t }) => t('plugin-ecommerce:purchased'),\n          value: 'purchased',\n        },\n        {\n          // @ts-expect-error - translations are not typed in plugins yet\n          label: ({ t }) => t('plugin-ecommerce:abandoned'),\n          value: 'abandoned',\n        },\n      ],\n      virtual: true,\n    },\n    ...(currenciesConfig\n      ? [\n          {\n            type: 'row',\n            admin: { position: 'sidebar' },\n            fields: [\n              amountField({\n                currenciesConfig,\n                overrides: {\n                  name: 'subtotal',\n\n                  label: ({ t }) =>\n                    // @ts-expect-error - translations are not typed in plugins yet\n                    t('plugin-ecommerce:subtotal'),\n                },\n              }),\n              currencyField({\n                currenciesConfig,\n              }),\n            ],\n          } as Field,\n        ]\n      : []),\n  ]\n\n  // Internal access function for guest users (unauthenticated)\n  const isGuest: Access = ({ req }) => !req.user\n\n  const baseConfig: CollectionConfig = {\n    slug: 'carts',\n    access: {\n      create: accessOR(\n        access.isAdmin,\n        access.isAuthenticated,\n        conditional(allowGuestCarts, isGuest),\n      ),\n      delete: accessOR(\n        access.isAdmin,\n        access.isDocumentOwner,\n        hasCartSecretAccess(allowGuestCarts),\n      ),\n      read: accessOR(access.isAdmin, access.isDocumentOwner, hasCartSecretAccess(allowGuestCarts)),\n      update: accessOR(\n        access.isAdmin,\n        access.isDocumentOwner,\n        hasCartSecretAccess(allowGuestCarts),\n      ),\n    },\n    admin: {\n      description: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:cartsCollectionDescription'),\n      group: 'Ecommerce',\n      useAsTitle: 'createdAt',\n    },\n    fields,\n    hooks: {\n      afterRead: [\n        ({ doc, req }) => {\n          // Include secret only if this was just created (stored in context by beforeChange)\n          if (req.context?.newCartSecret) {\n            doc.secret = req.context.newCartSecret\n          }\n          // Secret is otherwise never exposed (field access is locked)\n          return doc\n        },\n      ],\n      beforeChange: [\n        // This hook can be used to update the subtotal before saving the cart\n        beforeChangeCart({ productsSlug, variantsSlug }),\n      ],\n    },\n    labels: {\n      plural: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:carts'),\n      singular: ({ t }) =>\n        // @ts-expect-error - translations are not typed in plugins yet\n        t('plugin-ecommerce:cart'),\n    },\n    timestamps: true,\n  }\n\n  return { ...baseConfig }\n}\n"],"names":["amountField","cartItemsField","currencyField","accessOR","conditional","beforeChangeCart","hasCartSecretAccess","statusBeforeRead","createCartsCollection","props","access","allowGuestCarts","currenciesConfig","customersSlug","enableVariants","productsSlug","variantsSlug","fields","overrides","label","t","labels","plural","singular","name","type","create","read","update","admin","hidden","position","readOnly","index","relationTo","date","pickerAppearance","hooks","afterRead","options","value","virtual","isGuest","req","user","baseConfig","slug","isAdmin","isAuthenticated","delete","isDocumentOwner","description","group","useAsTitle","doc","context","newCartSecret","secret","beforeChange","timestamps"],"mappings":"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"}