{"version":3,"sources":["../../../src/collections/carts/populateTenant.ts"],"sourcesContent":["import type { CollectionBeforeChangeHook } from 'payload'\n\nimport { APIError, parseCookies } from 'payload'\n\ntype Props = {\n  tenantsSlug: string\n}\n\n/**\n * Populates the tenant field from request cookies.\n * This handles both:\n * - Creating carts with tenant from the domain (frontend via payload-tenant-domain cookie)\n * - Admin panel operations (via payload-tenant cookie)\n *\n * The hook only runs on create operations and only if tenant is not already set.\n * Throws an error if no valid tenant can be determined - all carts must belong to a tenant.\n */\nexport const populateTenant: (props: Props) => CollectionBeforeChangeHook =\n  ({ tenantsSlug }) =>\n  async ({ data, operation, req }) => {\n    // Only populate on create, and only if tenant not already set\n    if (operation !== 'create' || data.tenant) {\n      return data\n    }\n\n    const cookies = parseCookies(req.headers)\n\n    // Try to get tenant from payload-tenant cookie (admin panel / plugin standard)\n    const tenantIdFromCookie = cookies.get('payload-tenant')\n\n    if (tenantIdFromCookie) {\n      // Parse tenant ID - could be string from cookie, convert to number for PostgreSQL\n      const parsedTenantId = parseInt(tenantIdFromCookie, 10)\n      if (!Number.isNaN(parsedTenantId)) {\n        // Validate the tenant exists\n        const tenantExists = await req.payload.count({\n          collection: tenantsSlug,\n          where: { id: { equals: parsedTenantId } },\n        })\n\n        if (tenantExists.totalDocs > 0) {\n          data.tenant = parsedTenantId\n          return data\n        }\n      }\n    }\n\n    // Try to get tenant from payload-tenant-domain cookie (frontend domain-based)\n    const tenantDomain = cookies.get('payload-tenant-domain')\n\n    if (tenantDomain) {\n      const tenants = await req.payload.find({\n        collection: tenantsSlug,\n        where: { domain: { equals: tenantDomain } },\n        limit: 1,\n      })\n\n      if (tenants.docs.length > 0) {\n        data.tenant = tenants.docs[0].id\n        return data\n      }\n    }\n\n    // No valid tenant found - throw error\n    // All carts must belong to a tenant for proper isolation\n    throw new APIError(\n      'Cannot create cart without a valid tenant. Ensure payload-tenant or payload-tenant-domain cookie is set.',\n      400,\n    )\n  }\n"],"names":["APIError","parseCookies","populateTenant","tenantsSlug","data","operation","req","tenant","cookies","headers","tenantIdFromCookie","get","parsedTenantId","parseInt","Number","isNaN","tenantExists","payload","count","collection","where","id","equals","totalDocs","tenantDomain","tenants","find","domain","limit","docs","length"],"mappings":"AAEA,SAASA,QAAQ,EAAEC,YAAY,QAAQ,UAAS;AAMhD;;;;;;;;CAQC,GACD,OAAO,MAAMC,iBACX,CAAC,EAAEC,WAAW,EAAE,GAChB,OAAO,EAAEC,IAAI,EAAEC,SAAS,EAAEC,GAAG,EAAE;QAC7B,8DAA8D;QAC9D,IAAID,cAAc,YAAYD,KAAKG,MAAM,EAAE;YACzC,OAAOH;QACT;QAEA,MAAMI,UAAUP,aAAaK,IAAIG,OAAO;QAExC,+EAA+E;QAC/E,MAAMC,qBAAqBF,QAAQG,GAAG,CAAC;QAEvC,IAAID,oBAAoB;YACtB,kFAAkF;YAClF,MAAME,iBAAiBC,SAASH,oBAAoB;YACpD,IAAI,CAACI,OAAOC,KAAK,CAACH,iBAAiB;gBACjC,6BAA6B;gBAC7B,MAAMI,eAAe,MAAMV,IAAIW,OAAO,CAACC,KAAK,CAAC;oBAC3CC,YAAYhB;oBACZiB,OAAO;wBAAEC,IAAI;4BAAEC,QAAQV;wBAAe;oBAAE;gBAC1C;gBAEA,IAAII,aAAaO,SAAS,GAAG,GAAG;oBAC9BnB,KAAKG,MAAM,GAAGK;oBACd,OAAOR;gBACT;YACF;QACF;QAEA,8EAA8E;QAC9E,MAAMoB,eAAehB,QAAQG,GAAG,CAAC;QAEjC,IAAIa,cAAc;YAChB,MAAMC,UAAU,MAAMnB,IAAIW,OAAO,CAACS,IAAI,CAAC;gBACrCP,YAAYhB;gBACZiB,OAAO;oBAAEO,QAAQ;wBAAEL,QAAQE;oBAAa;gBAAE;gBAC1CI,OAAO;YACT;YAEA,IAAIH,QAAQI,IAAI,CAACC,MAAM,GAAG,GAAG;gBAC3B1B,KAAKG,MAAM,GAAGkB,QAAQI,IAAI,CAAC,EAAE,CAACR,EAAE;gBAChC,OAAOjB;YACT;QACF;QAEA,sCAAsC;QACtC,yDAAyD;QACzD,MAAM,IAAIJ,SACR,4GACA;IAEJ,EAAC"}