{"version":3,"sources":["../../../src/collections/carts/populateTenant.ts"],"sourcesContent":["import type { CollectionBeforeChangeHook } from 'payload'\n\nimport { APIError, parseCookies } from 'payload'\n\ntype Props = {\n  tenantsSlug: string\n}\n\n/**\n * Populates the tenant field from request cookies.\n * This handles both:\n * - Creating carts with tenant from the domain (frontend via payload-tenant-domain cookie)\n * - Admin panel operations (via payload-tenant cookie)\n *\n * The hook only runs on create operations and only if tenant is not already set.\n * Throws an error if no valid tenant can be determined - all carts must belong to a tenant.\n */\nexport const populateTenant: (props: Props) => CollectionBeforeChangeHook =\n  ({ tenantsSlug }) =>\n  async ({ data, operation, req }) => {\n    // Only populate on create, and only if tenant not already set\n    if (operation !== 'create' || data.tenant) {\n      return data\n    }\n\n    const cookies = parseCookies(req.headers)\n\n    // Try to get tenant from payload-tenant cookie (admin panel / plugin standard)\n    const tenantIdFromCookie = cookies.get('payload-tenant')\n\n    if (tenantIdFromCookie) {\n      // Validate the tenant exists\n      const tenantExists = await req.payload.count({\n        collection: tenantsSlug,\n        where: { id: { equals: tenantIdFromCookie } },\n      })\n\n      if (tenantExists.totalDocs > 0) {\n        data.tenant = tenantIdFromCookie\n        return data\n      }\n    }\n\n    // Try to get tenant from payload-tenant-domain cookie (frontend domain-based)\n    const tenantDomain = cookies.get('payload-tenant-domain')\n\n    if (tenantDomain) {\n      const tenants = await req.payload.find({\n        collection: tenantsSlug,\n        where: { domain: { equals: tenantDomain } },\n        limit: 1,\n      })\n\n      if (tenants.docs.length > 0) {\n        data.tenant = tenants.docs[0].id\n        return data\n      }\n    }\n\n    // No valid tenant found - throw error\n    // All carts must belong to a tenant for proper isolation\n    throw new APIError(\n      'Cannot create cart without a valid tenant. Ensure payload-tenant or payload-tenant-domain cookie is set.',\n      400,\n    )\n  }\n"],"names":["APIError","parseCookies","populateTenant","tenantsSlug","data","operation","req","tenant","cookies","headers","tenantIdFromCookie","get","tenantExists","payload","count","collection","where","id","equals","totalDocs","tenantDomain","tenants","find","domain","limit","docs","length"],"mappings":"AAEA,SAASA,QAAQ,EAAEC,YAAY,QAAQ,UAAS;AAMhD;;;;;;;;CAQC,GACD,OAAO,MAAMC,iBACX,CAAC,EAAEC,WAAW,EAAE,GAChB,OAAO,EAAEC,IAAI,EAAEC,SAAS,EAAEC,GAAG,EAAE;QAC7B,8DAA8D;QAC9D,IAAID,cAAc,YAAYD,KAAKG,MAAM,EAAE;YACzC,OAAOH;QACT;QAEA,MAAMI,UAAUP,aAAaK,IAAIG,OAAO;QAExC,+EAA+E;QAC/E,MAAMC,qBAAqBF,QAAQG,GAAG,CAAC;QAEvC,IAAID,oBAAoB;YACtB,6BAA6B;YAC7B,MAAME,eAAe,MAAMN,IAAIO,OAAO,CAACC,KAAK,CAAC;gBAC3CC,YAAYZ;gBACZa,OAAO;oBAAEC,IAAI;wBAAEC,QAAQR;oBAAmB;gBAAE;YAC9C;YAEA,IAAIE,aAAaO,SAAS,GAAG,GAAG;gBAC9Bf,KAAKG,MAAM,GAAGG;gBACd,OAAON;YACT;QACF;QAEA,8EAA8E;QAC9E,MAAMgB,eAAeZ,QAAQG,GAAG,CAAC;QAEjC,IAAIS,cAAc;YAChB,MAAMC,UAAU,MAAMf,IAAIO,OAAO,CAACS,IAAI,CAAC;gBACrCP,YAAYZ;gBACZa,OAAO;oBAAEO,QAAQ;wBAAEL,QAAQE;oBAAa;gBAAE;gBAC1CI,OAAO;YACT;YAEA,IAAIH,QAAQI,IAAI,CAACC,MAAM,GAAG,GAAG;gBAC3BtB,KAAKG,MAAM,GAAGc,QAAQI,IAAI,CAAC,EAAE,CAACR,EAAE;gBAChC,OAAOb;YACT;QACF;QAEA,sCAAsC;QACtC,yDAAyD;QACzD,MAAM,IAAIJ,SACR,4GACA;IAEJ,EAAC"}