{"version":3,"sources":["../../../src/collections/carts/cartTenantAccess.ts"],"sourcesContent":["import type { Access, Where } from 'payload'\n\nimport { parseCookies } from 'payload'\n\ntype Props = {\n  /**\n   * Access function to check if user is admin.\n   */\n  isAdmin: Access\n  /**\n   * Name of the array field containing user's tenant memberships.\n   * @default 'tenants'\n   */\n  tenantsArrayFieldName?: string\n  /**\n   * Name of the tenant field within the user's tenants array.\n   * @default 'tenant'\n   */\n  tenantsArrayTenantFieldName?: string\n  /**\n   * Roles that grant super-admin access (bypass all tenant filtering).\n   * @default ['super-admin']\n   */\n  superAdminRoles?: string[]\n}\n\n/**\n * Creates an access function that filters carts by tenant for admin users.\n *\n * For admins:\n * - Super-admins see all carts\n * - Tenant-admins see carts from their tenants OR carts without tenant\n *\n * For non-admins:\n * - Returns false (other access rules like isDocumentOwner or hasCartSecretAccess handle them)\n *\n * This is designed to be combined with other access functions using accessOR.\n */\nexport const hasTenantAccess = ({\n  isAdmin,\n  tenantsArrayFieldName = 'tenants',\n  tenantsArrayTenantFieldName = 'tenant',\n  superAdminRoles = ['super-admin'],\n}: Props): Access => {\n  return async ({ req }) => {\n    const { user } = req\n\n    // Only applies to authenticated users\n    if (!user) {\n      return false\n    }\n\n    // First check if user is admin at all\n    const adminResult = await isAdmin({ req } as Parameters<Access>[0])\n    if (!adminResult) {\n      return false\n    }\n\n    // Super-admin: full access (returns true to bypass any Where constraints)\n    const roles = user.roles as string[] | undefined\n    if (roles?.some((role) => superAdminRoles.includes(role))) {\n      return true\n    }\n\n    // Get user's tenant IDs from their tenants array\n    const userTenantIds: (string | number)[] = []\n    const tenantsArray = user[tenantsArrayFieldName] as\n      | Array<{ [key: string]: unknown }>\n      | undefined\n\n    if (Array.isArray(tenantsArray)) {\n      for (const membership of tenantsArray) {\n        const tenantValue = membership[tenantsArrayTenantFieldName]\n        if (tenantValue) {\n          const tenantId =\n            typeof tenantValue === 'object' && tenantValue !== null && 'id' in tenantValue\n              ? (tenantValue as { id: string | number }).id\n              : tenantValue\n          if (tenantId) {\n            userTenantIds.push(tenantId as string | number)\n          }\n        }\n      }\n    }\n\n    if (userTenantIds.length === 0) {\n      return false\n    }\n\n    // Check if there's a selected tenant in cookies (admin panel context)\n    const cookies = parseCookies(req.headers)\n    const selectedTenant = cookies.get('payload-tenant')\n\n    // If admin has selected a specific tenant, filter to that tenant\n    if (selectedTenant) {\n      const selectedTenantId = Number(selectedTenant) || selectedTenant\n      if (userTenantIds.includes(selectedTenantId)) {\n        return {\n          or: [{ tenant: { equals: selectedTenantId } }, { tenant: { exists: false } }],\n        } as Where\n      }\n    }\n\n    // Return Where clause filtering by user's tenants\n    // Include carts with no tenant (orphaned/guest carts before tenant was set)\n    return {\n      or: [{ tenant: { in: userTenantIds } }, { tenant: { exists: false } }],\n    } as Where\n  }\n}\n"],"names":["parseCookies","hasTenantAccess","isAdmin","tenantsArrayFieldName","tenantsArrayTenantFieldName","superAdminRoles","req","user","adminResult","roles","some","role","includes","userTenantIds","tenantsArray","Array","isArray","membership","tenantValue","tenantId","id","push","length","cookies","headers","selectedTenant","get","selectedTenantId","Number","or","tenant","equals","exists","in"],"mappings":"AAEA,SAASA,YAAY,QAAQ,UAAS;AAwBtC;;;;;;;;;;;CAWC,GACD,OAAO,MAAMC,kBAAkB,CAAC,EAC9BC,OAAO,EACPC,wBAAwB,SAAS,EACjCC,8BAA8B,QAAQ,EACtCC,kBAAkB;IAAC;CAAc,EAC3B;IACN,OAAO,OAAO,EAAEC,GAAG,EAAE;QACnB,MAAM,EAAEC,IAAI,EAAE,GAAGD;QAEjB,sCAAsC;QACtC,IAAI,CAACC,MAAM;YACT,OAAO;QACT;QAEA,sCAAsC;QACtC,MAAMC,cAAc,MAAMN,QAAQ;YAAEI;QAAI;QACxC,IAAI,CAACE,aAAa;YAChB,OAAO;QACT;QAEA,0EAA0E;QAC1E,MAAMC,QAAQF,KAAKE,KAAK;QACxB,IAAIA,OAAOC,KAAK,CAACC,OAASN,gBAAgBO,QAAQ,CAACD,QAAQ;YACzD,OAAO;QACT;QAEA,iDAAiD;QACjD,MAAME,gBAAqC,EAAE;QAC7C,MAAMC,eAAeP,IAAI,CAACJ,sBAAsB;QAIhD,IAAIY,MAAMC,OAAO,CAACF,eAAe;YAC/B,KAAK,MAAMG,cAAcH,aAAc;gBACrC,MAAMI,cAAcD,UAAU,CAACb,4BAA4B;gBAC3D,IAAIc,aAAa;oBACf,MAAMC,WACJ,OAAOD,gBAAgB,YAAYA,gBAAgB,QAAQ,QAAQA,cAC/D,AAACA,YAAwCE,EAAE,GAC3CF;oBACN,IAAIC,UAAU;wBACZN,cAAcQ,IAAI,CAACF;oBACrB;gBACF;YACF;QACF;QAEA,IAAIN,cAAcS,MAAM,KAAK,GAAG;YAC9B,OAAO;QACT;QAEA,sEAAsE;QACtE,MAAMC,UAAUvB,aAAaM,IAAIkB,OAAO;QACxC,MAAMC,iBAAiBF,QAAQG,GAAG,CAAC;QAEnC,iEAAiE;QACjE,IAAID,gBAAgB;YAClB,MAAME,mBAAmBC,OAAOH,mBAAmBA;YACnD,IAAIZ,cAAcD,QAAQ,CAACe,mBAAmB;gBAC5C,OAAO;oBACLE,IAAI;wBAAC;4BAAEC,QAAQ;gCAAEC,QAAQJ;4BAAiB;wBAAE;wBAAG;4BAAEG,QAAQ;gCAAEE,QAAQ;4BAAM;wBAAE;qBAAE;gBAC/E;YACF;QACF;QAEA,kDAAkD;QAClD,4EAA4E;QAC5E,OAAO;YACLH,IAAI;gBAAC;oBAAEC,QAAQ;wBAAEG,IAAIpB;oBAAc;gBAAE;gBAAG;oBAAEiB,QAAQ;wBAAEE,QAAQ;oBAAM;gBAAE;aAAE;QACxE;IACF;AACF,EAAC"}