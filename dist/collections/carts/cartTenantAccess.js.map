{"version":3,"sources":["../../../src/collections/carts/cartTenantAccess.ts"],"sourcesContent":["import type { Access, Where } from 'payload'\n\nimport { parseCookies } from 'payload'\n\ntype Props = {\n  /**\n   * Access function to check if user is admin.\n   * This is used as a fallback check. Tenant-admin roles are checked separately.\n   */\n  isAdmin: Access\n  /**\n   * Name of the array field containing user's tenant memberships.\n   * @default 'tenants'\n   */\n  tenantsArrayFieldName?: string\n  /**\n   * Name of the tenant field within the user's tenants array.\n   * @default 'tenant'\n   */\n  tenantsArrayTenantFieldName?: string\n  /**\n   * Name of the roles field within each tenant membership.\n   * @default 'roles'\n   */\n  tenantsArrayRolesFieldName?: string\n  /**\n   * Roles that grant super-admin access (bypass all tenant filtering).\n   * @default ['super-admin']\n   */\n  superAdminRoles?: string[]\n  /**\n   * Roles in tenant membership that grant tenant-admin access.\n   * @default ['tenant-admin']\n   */\n  tenantAdminRoles?: string[]\n}\n\n/**\n * Creates an access function that filters carts by tenant for admin users.\n *\n * For admins:\n * - Super-admins see all carts\n * - Global admins see all carts for their tenants\n * - Tenant-admins see carts from tenants where they have admin role\n *\n * For non-admins:\n * - Returns false (other access rules like isDocumentOwner or hasCartSecretAccess handle them)\n *\n * This is designed to be combined with other access functions using accessOR.\n */\nexport const hasTenantAccess = ({\n  isAdmin,\n  tenantsArrayFieldName = 'tenants',\n  tenantsArrayTenantFieldName = 'tenant',\n  tenantsArrayRolesFieldName = 'roles',\n  superAdminRoles = ['super-admin'],\n  tenantAdminRoles = ['tenant-admin'],\n}: Props): Access => {\n  return async ({ req }) => {\n    const { user } = req\n\n    // Only applies to authenticated users\n    if (!user) {\n      return false\n    }\n\n    // Check super-admin FIRST (before other checks)\n    // Super-admin: full access (returns true to bypass any Where constraints)\n    const roles = user.roles as string[] | undefined\n    if (roles?.some((role) => superAdminRoles.includes(role))) {\n      return true\n    }\n\n    // Get user's tenant memberships and check for tenant-admin roles\n    const adminTenantIds: (string | number)[] = []\n    const tenantsArray = user[tenantsArrayFieldName] as\n      | Array<{ [key: string]: unknown }>\n      | undefined\n\n    if (Array.isArray(tenantsArray)) {\n      for (const membership of tenantsArray) {\n        const tenantValue = membership[tenantsArrayTenantFieldName]\n        const membershipRoles = membership[tenantsArrayRolesFieldName] as string[] | undefined\n\n        // Check if user has tenant-admin role in this membership\n        const hasTenantAdminRole = membershipRoles?.some((role) => tenantAdminRoles.includes(role))\n\n        if (tenantValue && hasTenantAdminRole) {\n          const tenantId =\n            typeof tenantValue === 'object' && tenantValue !== null && 'id' in tenantValue\n              ? (tenantValue as { id: string | number }).id\n              : tenantValue\n          if (tenantId) {\n            adminTenantIds.push(tenantId as string | number)\n          }\n        }\n      }\n    }\n\n    // If user has tenant-admin role in any tenant, grant access to those tenants\n    if (adminTenantIds.length > 0) {\n      // Check if there's a selected tenant in cookies (admin panel context)\n      const cookies = parseCookies(req.headers)\n      const selectedTenant = cookies.get('payload-tenant')\n\n      // If admin has selected a specific tenant, filter to that tenant\n      if (selectedTenant) {\n        const selectedTenantId = Number(selectedTenant) || selectedTenant\n        if (adminTenantIds.includes(selectedTenantId)) {\n          return {\n            or: [{ tenant: { equals: selectedTenantId } }, { tenant: { exists: false } }],\n          } as Where\n        }\n      }\n\n      // Return Where clause filtering by user's admin tenants\n      // Include carts with no tenant (orphaned/guest carts before tenant was set)\n      return {\n        or: [{ tenant: { in: adminTenantIds } }, { tenant: { exists: false } }],\n      } as Where\n    }\n\n    // Fallback: check if user is global admin via the provided isAdmin function\n    const adminResult = await isAdmin({ req } as Parameters<Access>[0])\n    if (adminResult) {\n      // Global admin but no tenant memberships - get all tenants from their array\n      const allTenantIds: (string | number)[] = []\n      if (Array.isArray(tenantsArray)) {\n        for (const membership of tenantsArray) {\n          const tenantValue = membership[tenantsArrayTenantFieldName]\n          if (tenantValue) {\n            const tenantId =\n              typeof tenantValue === 'object' && tenantValue !== null && 'id' in tenantValue\n                ? (tenantValue as { id: string | number }).id\n                : tenantValue\n            if (tenantId) {\n              allTenantIds.push(tenantId as string | number)\n            }\n          }\n        }\n      }\n\n      if (allTenantIds.length > 0) {\n        return {\n          or: [{ tenant: { in: allTenantIds } }, { tenant: { exists: false } }],\n        } as Where\n      }\n\n      // Global admin with no tenant memberships - return true for full access\n      return true\n    }\n\n    // Not an admin of any kind\n    return false\n  }\n}\n"],"names":["parseCookies","hasTenantAccess","isAdmin","tenantsArrayFieldName","tenantsArrayTenantFieldName","tenantsArrayRolesFieldName","superAdminRoles","tenantAdminRoles","req","user","roles","some","role","includes","adminTenantIds","tenantsArray","Array","isArray","membership","tenantValue","membershipRoles","hasTenantAdminRole","tenantId","id","push","length","cookies","headers","selectedTenant","get","selectedTenantId","Number","or","tenant","equals","exists","in","adminResult","allTenantIds"],"mappings":"AAEA,SAASA,YAAY,QAAQ,UAAS;AAmCtC;;;;;;;;;;;;CAYC,GACD,OAAO,MAAMC,kBAAkB,CAAC,EAC9BC,OAAO,EACPC,wBAAwB,SAAS,EACjCC,8BAA8B,QAAQ,EACtCC,6BAA6B,OAAO,EACpCC,kBAAkB;IAAC;CAAc,EACjCC,mBAAmB;IAAC;CAAe,EAC7B;IACN,OAAO,OAAO,EAAEC,GAAG,EAAE;QACnB,MAAM,EAAEC,IAAI,EAAE,GAAGD;QAEjB,sCAAsC;QACtC,IAAI,CAACC,MAAM;YACT,OAAO;QACT;QAEA,gDAAgD;QAChD,0EAA0E;QAC1E,MAAMC,QAAQD,KAAKC,KAAK;QACxB,IAAIA,OAAOC,KAAK,CAACC,OAASN,gBAAgBO,QAAQ,CAACD,QAAQ;YACzD,OAAO;QACT;QAEA,iEAAiE;QACjE,MAAME,iBAAsC,EAAE;QAC9C,MAAMC,eAAeN,IAAI,CAACN,sBAAsB;QAIhD,IAAIa,MAAMC,OAAO,CAACF,eAAe;YAC/B,KAAK,MAAMG,cAAcH,aAAc;gBACrC,MAAMI,cAAcD,UAAU,CAACd,4BAA4B;gBAC3D,MAAMgB,kBAAkBF,UAAU,CAACb,2BAA2B;gBAE9D,yDAAyD;gBACzD,MAAMgB,qBAAqBD,iBAAiBT,KAAK,CAACC,OAASL,iBAAiBM,QAAQ,CAACD;gBAErF,IAAIO,eAAeE,oBAAoB;oBACrC,MAAMC,WACJ,OAAOH,gBAAgB,YAAYA,gBAAgB,QAAQ,QAAQA,cAC/D,AAACA,YAAwCI,EAAE,GAC3CJ;oBACN,IAAIG,UAAU;wBACZR,eAAeU,IAAI,CAACF;oBACtB;gBACF;YACF;QACF;QAEA,6EAA6E;QAC7E,IAAIR,eAAeW,MAAM,GAAG,GAAG;YAC7B,sEAAsE;YACtE,MAAMC,UAAU1B,aAAaQ,IAAImB,OAAO;YACxC,MAAMC,iBAAiBF,QAAQG,GAAG,CAAC;YAEnC,iEAAiE;YACjE,IAAID,gBAAgB;gBAClB,MAAME,mBAAmBC,OAAOH,mBAAmBA;gBACnD,IAAId,eAAeD,QAAQ,CAACiB,mBAAmB;oBAC7C,OAAO;wBACLE,IAAI;4BAAC;gCAAEC,QAAQ;oCAAEC,QAAQJ;gCAAiB;4BAAE;4BAAG;gCAAEG,QAAQ;oCAAEE,QAAQ;gCAAM;4BAAE;yBAAE;oBAC/E;gBACF;YACF;YAEA,wDAAwD;YACxD,4EAA4E;YAC5E,OAAO;gBACLH,IAAI;oBAAC;wBAAEC,QAAQ;4BAAEG,IAAItB;wBAAe;oBAAE;oBAAG;wBAAEmB,QAAQ;4BAAEE,QAAQ;wBAAM;oBAAE;iBAAE;YACzE;QACF;QAEA,4EAA4E;QAC5E,MAAME,cAAc,MAAMnC,QAAQ;YAAEM;QAAI;QACxC,IAAI6B,aAAa;YACf,4EAA4E;YAC5E,MAAMC,eAAoC,EAAE;YAC5C,IAAItB,MAAMC,OAAO,CAACF,eAAe;gBAC/B,KAAK,MAAMG,cAAcH,aAAc;oBACrC,MAAMI,cAAcD,UAAU,CAACd,4BAA4B;oBAC3D,IAAIe,aAAa;wBACf,MAAMG,WACJ,OAAOH,gBAAgB,YAAYA,gBAAgB,QAAQ,QAAQA,cAC/D,AAACA,YAAwCI,EAAE,GAC3CJ;wBACN,IAAIG,UAAU;4BACZgB,aAAad,IAAI,CAACF;wBACpB;oBACF;gBACF;YACF;YAEA,IAAIgB,aAAab,MAAM,GAAG,GAAG;gBAC3B,OAAO;oBACLO,IAAI;wBAAC;4BAAEC,QAAQ;gCAAEG,IAAIE;4BAAa;wBAAE;wBAAG;4BAAEL,QAAQ;gCAAEE,QAAQ;4BAAM;wBAAE;qBAAE;gBACvE;YACF;YAEA,wEAAwE;YACxE,OAAO;QACT;QAEA,2BAA2B;QAC3B,OAAO;IACT;AACF,EAAC"}