{"version":3,"sources":["../../../src/react/provider/index.tsx"],"sourcesContent":["'use client'\nimport type { DefaultDocumentIDType, TypedUser } from 'payload'\n\nimport { deepMergeSimple, formatAdminURL } from 'payload/shared'\nimport * as qs from 'qs-esm'\nimport React, {\n  createContext,\n  use,\n  useCallback,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n} from 'react'\n\nimport type {\n  AddressesCollection,\n  CartsCollection,\n  ContextProps,\n  Currency,\n  EcommerceConfig,\n  EcommerceContextType,\n} from '../../types/index.js'\n\nconst defaultContext: EcommerceContextType = {\n  addItem: async () => {},\n  clearCart: async () => {},\n  clearSession: () => {},\n  config: {\n    addressesSlug: 'addresses',\n    api: {\n      apiRoute: '/api',\n    },\n    cartsSlug: 'carts',\n    customersSlug: 'users',\n  },\n  confirmOrder: async () => {},\n  createAddress: async () => {},\n  deleteAddress: async () => {},\n  currenciesConfig: {\n    defaultCurrency: 'USD',\n    supportedCurrencies: [\n      {\n        code: 'USD',\n        decimals: 2,\n        label: 'US Dollar',\n        symbol: '$',\n      },\n    ],\n  },\n  currency: {\n    code: 'USD',\n    decimals: 2,\n    label: 'US Dollar',\n    symbol: '$',\n  },\n  decrementItem: async () => {},\n  incrementItem: async () => {},\n  initiatePayment: async () => {},\n  isLoading: false,\n  mergeCart: async () => ({}) as CartsCollection,\n  onLogin: async () => {},\n  onLogout: () => {},\n  paymentMethods: [],\n  refreshCart: async () => {},\n  refreshUser: async () => {},\n  removeItem: async () => {},\n  setCurrency: () => {},\n  updateAddress: async () => {},\n  user: null,\n}\n\nconst EcommerceContext = createContext<EcommerceContextType>(defaultContext)\n\nconst defaultLocalStorage = {\n  key: 'cart',\n}\n\nexport const EcommerceProvider: React.FC<ContextProps> = ({\n  addressesSlug = 'addresses',\n  api,\n  cartsSlug = 'carts',\n  children,\n  currenciesConfig = {\n    defaultCurrency: 'USD',\n    supportedCurrencies: [\n      {\n        code: 'USD',\n        decimals: 2,\n        label: 'US Dollar',\n        symbol: '$',\n      },\n    ],\n  },\n  customersSlug = 'users',\n  debug = false,\n  paymentMethods = [],\n  syncLocalStorage = true,\n}) => {\n  const localStorageConfig =\n    syncLocalStorage && typeof syncLocalStorage === 'object'\n      ? {\n          ...defaultLocalStorage,\n          ...syncLocalStorage,\n        }\n      : defaultLocalStorage\n\n  const { apiRoute = '/api', cartsFetchQuery = {} } = api || {}\n  const baseAPIURL = formatAdminURL({\n    apiRoute,\n    path: '',\n  })\n\n  const config = useMemo<EcommerceConfig>(\n    () => ({\n      addressesSlug,\n      api: {\n        apiRoute,\n      },\n      cartsSlug,\n      customersSlug,\n    }),\n    [addressesSlug, apiRoute, cartsSlug, customersSlug],\n  )\n\n  const [isLoading, setIsLoading] = useState(false)\n\n  const [user, setUser] = useState<null | TypedUser>(null)\n\n  const [addresses, setAddresses] = useState<AddressesCollection[]>()\n\n  const hasRendered = useRef(false)\n\n  /**\n   * The ID of the cart associated with the current session.\n   * This is used to identify the cart in the database or local storage.\n   * It can be null if no cart has been created yet.\n   */\n  const [cartID, setCartID] = useState<DefaultDocumentIDType>()\n  /**\n   * The secret for accessing guest carts without authentication.\n   * This is generated when a guest user creates a cart.\n   */\n  const [cartSecret, setCartSecret] = useState<string | undefined>(undefined)\n  const [cart, setCart] = useState<CartsCollection>()\n\n  const [selectedCurrency, setSelectedCurrency] = useState<Currency>(\n    () =>\n      currenciesConfig.supportedCurrencies.find(\n        (c) => c.code === currenciesConfig.defaultCurrency,\n      )!,\n  )\n\n  const [selectedPaymentMethod, setSelectedPaymentMethod] = useState<null | string>(null)\n\n  const cartQuery = useMemo(() => {\n    const priceField = `priceIn${selectedCurrency.code}`\n\n    const baseQuery = {\n      depth: 0,\n      populate: {\n        products: {\n          [priceField]: true,\n        },\n        variants: {\n          options: true,\n          [priceField]: true,\n        },\n      },\n      select: {\n        items: true,\n        subtotal: true,\n      },\n    }\n\n    return deepMergeSimple(baseQuery, cartsFetchQuery)\n  }, [selectedCurrency.code, cartsFetchQuery])\n\n  const createCart = useCallback(\n    async (initialData: Record<string, unknown>) => {\n      const query = qs.stringify(cartQuery)\n\n      const response = await fetch(`${baseAPIURL}/${cartsSlug}?${query}`, {\n        body: JSON.stringify({\n          ...initialData,\n          currency: selectedCurrency.code,\n          customer: user?.id,\n        }),\n        credentials: 'include',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        method: 'POST',\n      })\n\n      if (!response.ok) {\n        const errorText = await response.text()\n        throw new Error(`Failed to create cart: ${errorText}`)\n      }\n\n      const data = await response.json()\n\n      if (data.error) {\n        throw new Error(`Cart creation error: ${data.error}`)\n      }\n\n      // Store the secret for guest cart access\n      if (!user && data.doc?.secret) {\n        setCartSecret(data.doc.secret)\n      }\n\n      return data.doc as CartsCollection\n    },\n    [baseAPIURL, cartQuery, cartsSlug, selectedCurrency.code, user],\n  )\n\n  const getCart = useCallback(\n    async (cartID: DefaultDocumentIDType, options?: { secret?: string }) => {\n      const secret = options?.secret\n\n      // Build query params with secret if provided\n      const queryParams = {\n        ...cartQuery,\n        ...(secret ? { secret } : {}),\n      }\n      const query = qs.stringify(queryParams)\n\n      const response = await fetch(`${baseAPIURL}/${cartsSlug}/${cartID}?${query}`, {\n        credentials: 'include',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        method: 'GET',\n      })\n\n      if (!response.ok) {\n        const errorText = await response.text()\n        throw new Error(`Failed to fetch cart: ${errorText}`)\n      }\n\n      const data = await response.json()\n\n      if (data.error) {\n        throw new Error(`Cart fetch error: ${data.error}`)\n      }\n\n      return data as CartsCollection\n    },\n    [baseAPIURL, cartQuery, cartsSlug],\n  )\n\n  const updateCart = useCallback(\n    async (cartID: DefaultDocumentIDType, data: Partial<CartsCollection>) => {\n      // Build query params with secret if provided\n      const queryParams = {\n        ...cartQuery,\n        ...(cartSecret ? { secret: cartSecret } : {}),\n      }\n      const query = qs.stringify(queryParams)\n\n      const response = await fetch(`${baseAPIURL}/${cartsSlug}/${cartID}?${query}`, {\n        body: JSON.stringify(data),\n        credentials: 'include',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        method: 'PATCH',\n      })\n\n      if (!response.ok) {\n        const errorText = await response.text()\n        throw new Error(`Failed to update cart: ${errorText}`)\n      }\n\n      const updatedCart = await response.json()\n\n      setCart(updatedCart.doc as CartsCollection)\n    },\n    [baseAPIURL, cartQuery, cartsSlug, cartSecret],\n  )\n\n  const deleteCart = useCallback(\n    async (cartID: DefaultDocumentIDType) => {\n      // Build query params with secret if provided\n      const queryParams = cartSecret ? { secret: cartSecret } : {}\n      const query = qs.stringify(queryParams)\n      const url = `${baseAPIURL}/${cartsSlug}/${cartID}${query ? `?${query}` : ''}`\n\n      const response = await fetch(url, {\n        credentials: 'include',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        method: 'DELETE',\n      })\n\n      if (!response.ok) {\n        const errorText = await response.text()\n        throw new Error(`Failed to delete cart: ${errorText}`)\n      }\n\n      setCart(undefined)\n      setCartID(undefined)\n      setCartSecret(undefined)\n    },\n    [baseAPIURL, cartsSlug, cartSecret],\n  )\n\n  // Persist cart ID and secret to localStorage\n  useEffect(() => {\n    if (hasRendered.current) {\n      if (syncLocalStorage) {\n        if (cartID) {\n          localStorage.setItem(localStorageConfig.key, cartID as string)\n        } else {\n          localStorage.removeItem(localStorageConfig.key)\n        }\n\n        if (cartSecret) {\n          localStorage.setItem(`${localStorageConfig.key}_secret`, cartSecret)\n        } else {\n          localStorage.removeItem(`${localStorageConfig.key}_secret`)\n        }\n      }\n    }\n  }, [cartID, cartSecret, localStorageConfig.key, syncLocalStorage])\n\n  const addItem: EcommerceContextType['addItem'] = useCallback(\n    async (item, quantity = 1) => {\n      setIsLoading(true)\n      try {\n        if (cartID) {\n          // Use server-side endpoint for adding items\n          const response = await fetch(`${baseAPIURL}/${cartsSlug}/${cartID}/add-item`, {\n            body: JSON.stringify({\n              item,\n              quantity,\n              secret: cartSecret,\n            }),\n            credentials: 'include',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            method: 'POST',\n          })\n\n          if (!response.ok) {\n            const errorText = await response.text()\n            throw new Error(`Failed to add item: ${errorText}`)\n          }\n\n          const result = await response.json()\n\n          if (!result.success) {\n            // Cart not found - reset state\n            setCartID(undefined)\n            setCart(undefined)\n            setCartSecret(undefined)\n            return\n          }\n\n          // Refresh cart with proper depth/populate settings for UI\n          const refreshedCart = await getCart(cartID, { secret: cartSecret })\n          setCart(refreshedCart)\n        } else {\n          // If no cartID exists, create a new cart with the item\n          const newCart = await createCart({ items: [{ ...item, quantity }] })\n\n          setCartID(newCart.id)\n          setCart(newCart)\n        }\n      } catch (error) {\n        if (debug) {\n          // eslint-disable-next-line no-console\n          console.error('Error adding item to cart:', error)\n        }\n      } finally {\n        setIsLoading(false)\n      }\n    },\n    [baseAPIURL, cartID, cartSecret, cartsSlug, createCart, debug, getCart],\n  )\n\n  const removeItem: EcommerceContextType['removeItem'] = useCallback(\n    async (targetID) => {\n      if (!cartID) {\n        return\n      }\n\n      setIsLoading(true)\n      try {\n        const response = await fetch(`${baseAPIURL}/${cartsSlug}/${cartID}/remove-item`, {\n          body: JSON.stringify({\n            itemID: targetID,\n            secret: cartSecret,\n          }),\n          credentials: 'include',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          method: 'POST',\n        })\n\n        if (!response.ok) {\n          const errorText = await response.text()\n          throw new Error(`Failed to remove item: ${errorText}`)\n        }\n\n        const result = await response.json()\n\n        if (!result.success) {\n          // Cart not found - reset state\n          setCartID(undefined)\n          setCart(undefined)\n          setCartSecret(undefined)\n          return\n        }\n\n        // Refresh cart with proper depth/populate settings for UI\n        const refreshedCart = await getCart(cartID, { secret: cartSecret })\n        setCart(refreshedCart)\n      } catch (error) {\n        if (debug) {\n          // eslint-disable-next-line no-console\n          console.error('Error removing item from cart:', error)\n        }\n      } finally {\n        setIsLoading(false)\n      }\n    },\n    [baseAPIURL, cartID, cartSecret, cartsSlug, debug, getCart],\n  )\n\n  const incrementItem: EcommerceContextType['incrementItem'] = useCallback(\n    async (targetID) => {\n      if (!cartID) {\n        return\n      }\n\n      setIsLoading(true)\n      try {\n        const response = await fetch(`${baseAPIURL}/${cartsSlug}/${cartID}/update-item`, {\n          body: JSON.stringify({\n            itemID: targetID,\n            quantity: { $inc: 1 },\n            secret: cartSecret,\n          }),\n          credentials: 'include',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          method: 'POST',\n        })\n\n        if (!response.ok) {\n          const errorText = await response.text()\n          throw new Error(`Failed to increment item: ${errorText}`)\n        }\n\n        const result = await response.json()\n\n        if (!result.success) {\n          // Cart not found - reset state\n          setCartID(undefined)\n          setCart(undefined)\n          setCartSecret(undefined)\n          return\n        }\n\n        // Refresh cart with proper depth/populate settings for UI\n        const refreshedCart = await getCart(cartID, { secret: cartSecret })\n        setCart(refreshedCart)\n      } catch (error) {\n        if (debug) {\n          // eslint-disable-next-line no-console\n          console.error('Error incrementing item quantity:', error)\n        }\n      } finally {\n        setIsLoading(false)\n      }\n    },\n    [baseAPIURL, cartID, cartSecret, cartsSlug, debug, getCart],\n  )\n\n  const decrementItem: EcommerceContextType['decrementItem'] = useCallback(\n    async (targetID) => {\n      if (!cartID) {\n        return\n      }\n\n      setIsLoading(true)\n      try {\n        const response = await fetch(`${baseAPIURL}/${cartsSlug}/${cartID}/update-item`, {\n          body: JSON.stringify({\n            itemID: targetID,\n            quantity: { $inc: -1 },\n            secret: cartSecret,\n          }),\n          credentials: 'include',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          method: 'POST',\n        })\n\n        if (!response.ok) {\n          const errorText = await response.text()\n          throw new Error(`Failed to decrement item: ${errorText}`)\n        }\n\n        const result = await response.json()\n\n        if (!result.success) {\n          // Cart not found - reset state\n          setCartID(undefined)\n          setCart(undefined)\n          setCartSecret(undefined)\n          return\n        }\n\n        // Refresh cart with proper depth/populate settings for UI\n        const refreshedCart = await getCart(cartID, { secret: cartSecret })\n        setCart(refreshedCart)\n      } catch (error) {\n        if (debug) {\n          // eslint-disable-next-line no-console\n          console.error('Error decrementing item quantity:', error)\n        }\n      } finally {\n        setIsLoading(false)\n      }\n    },\n    [baseAPIURL, cartID, cartSecret, cartsSlug, debug, getCart],\n  )\n\n  const clearCart: EcommerceContextType['clearCart'] = useCallback(async () => {\n    if (!cartID) {\n      return\n    }\n\n    setIsLoading(true)\n    try {\n      const response = await fetch(`${baseAPIURL}/${cartsSlug}/${cartID}/clear`, {\n        body: JSON.stringify({\n          secret: cartSecret,\n        }),\n        credentials: 'include',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        method: 'POST',\n      })\n\n      if (!response.ok) {\n        const errorText = await response.text()\n        throw new Error(`Failed to clear cart: ${errorText}`)\n      }\n\n      const result = await response.json()\n\n      if (!result.success) {\n        // Cart not found - reset state\n        setCartID(undefined)\n        setCart(undefined)\n        setCartSecret(undefined)\n        return\n      }\n\n      // Refresh cart with proper depth/populate settings for UI\n      const refreshedCart = await getCart(cartID, { secret: cartSecret })\n      setCart(refreshedCart)\n    } catch (error) {\n      if (debug) {\n        // eslint-disable-next-line no-console\n        console.error('Error clearing cart:', error)\n      }\n    } finally {\n      setIsLoading(false)\n    }\n  }, [baseAPIURL, cartID, cartSecret, cartsSlug, debug, getCart])\n\n  const setCurrency: EcommerceContextType['setCurrency'] = useCallback(\n    (currency) => {\n      if (selectedCurrency.code === currency) {\n        return\n      }\n\n      const foundCurrency = currenciesConfig.supportedCurrencies.find((c) => c.code === currency)\n      if (!foundCurrency) {\n        throw new Error(`Currency with code \"${currency}\" not found in config`)\n      }\n\n      setSelectedCurrency(foundCurrency)\n    },\n    [currenciesConfig.supportedCurrencies, selectedCurrency.code],\n  )\n\n  const initiatePayment = useCallback<EcommerceContextType['initiatePayment']>(\n    async (paymentMethodID, options) => {\n      const paymentMethod = paymentMethods.find((method) => method.name === paymentMethodID)\n\n      if (!paymentMethod) {\n        throw new Error(`Payment method with ID \"${paymentMethodID}\" not found`)\n      }\n\n      if (!cartID) {\n        throw new Error(`No cart is provided.`)\n      }\n\n      setSelectedPaymentMethod(paymentMethodID)\n\n      if (paymentMethod.initiatePayment) {\n        const fetchURL = `${baseAPIURL}/payments/${paymentMethodID}/initiate`\n\n        const data = {\n          cartID,\n          currency: selectedCurrency.code,\n        }\n\n        try {\n          const response = await fetch(fetchURL, {\n            body: JSON.stringify({\n              ...data,\n              ...(options?.additionalData || {}),\n            }),\n            credentials: 'include',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            method: 'POST',\n          })\n\n          if (!response.ok) {\n            const responseError = await response.text()\n            throw new Error(responseError)\n          }\n\n          const responseData = await response.json()\n\n          if (responseData.error) {\n            throw new Error(responseData.error)\n          }\n\n          return responseData\n        } catch (error) {\n          if (debug) {\n            // eslint-disable-next-line no-console\n            console.error('Error initiating payment:', error)\n          }\n          throw new Error(error instanceof Error ? error.message : 'Failed to initiate payment')\n        }\n      } else {\n        throw new Error(`Payment method \"${paymentMethodID}\" does not support payment initiation`)\n      }\n    },\n    [baseAPIURL, cartID, debug, paymentMethods, selectedCurrency.code],\n  )\n\n  const confirmOrder = useCallback<EcommerceContextType['initiatePayment']>(\n    async (paymentMethodID, options) => {\n      if (!cartID) {\n        throw new Error(`Cart is empty.`)\n      }\n\n      const paymentMethod = paymentMethods.find((pm) => pm.name === paymentMethodID)\n\n      if (!paymentMethod) {\n        throw new Error(`Payment method with ID \"${paymentMethodID}\" not found`)\n      }\n\n      if (paymentMethod.confirmOrder) {\n        const fetchURL = `${baseAPIURL}/payments/${paymentMethodID}/confirm-order`\n\n        const data = {\n          cartID,\n          currency: selectedCurrency.code,\n        }\n\n        const response = await fetch(fetchURL, {\n          body: JSON.stringify({\n            ...data,\n            ...(options?.additionalData || {}),\n          }),\n          credentials: 'include',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          method: 'POST',\n        })\n\n        if (!response.ok) {\n          const responseError = await response.text()\n          throw new Error(responseError)\n        }\n\n        const responseData = await response.json()\n\n        if (responseData.error) {\n          throw new Error(responseData.error)\n        }\n\n        return responseData\n      } else {\n        throw new Error(`Payment method \"${paymentMethodID}\" does not support order confirmation`)\n      }\n    },\n    [baseAPIURL, cartID, paymentMethods, selectedCurrency.code],\n  )\n\n  const getUser = useCallback(async () => {\n    try {\n      const query = qs.stringify({\n        depth: 0,\n        select: {\n          id: true,\n          carts: true,\n        },\n      })\n\n      const response = await fetch(`${baseAPIURL}/${customersSlug}/me?${query}`, {\n        credentials: 'include',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        method: 'GET',\n      })\n\n      if (!response.ok) {\n        const errorText = await response.text()\n        throw new Error(`Failed to fetch user: ${errorText}`)\n      }\n\n      const userData = await response.json()\n\n      if (userData.error) {\n        throw new Error(`User fetch error: ${userData.error}`)\n      }\n\n      if (userData.user) {\n        setUser(userData.user as TypedUser)\n        return userData.user as TypedUser\n      }\n    } catch (error) {\n      if (debug) {\n        // eslint-disable-next-line no-console\n        console.error('Error fetching user:', error)\n      }\n      setUser(null)\n      throw new Error(\n        `Failed to fetch user: ${error instanceof Error ? error.message : 'Unknown error'}`,\n      )\n    }\n  }, [baseAPIURL, customersSlug, debug])\n\n  const refreshUser = useCallback<EcommerceContextType['refreshUser']>(async () => {\n    try {\n      const fetchedUser = await getUser()\n      if (fetchedUser && fetchedUser.cart?.docs && fetchedUser.cart.docs.length > 0) {\n        const userCartID =\n          typeof fetchedUser.cart.docs[0] === 'object'\n            ? fetchedUser.cart.docs[0].id\n            : fetchedUser.cart.docs[0]\n\n        if (userCartID) {\n          const fetchedCart = await getCart(userCartID)\n          setCart(fetchedCart)\n          setCartID(userCartID)\n        }\n      }\n    } catch (error) {\n      // User is not logged in, clear cart state for authenticated user\n      setUser(null)\n      // Don't clear cart - keep localStorage cart for guest\n    }\n  }, [getCart, getUser])\n\n  const getAddresses = useCallback(async () => {\n    if (!user) {\n      return\n    }\n\n    try {\n      const query = qs.stringify({\n        depth: 0,\n        limit: 0,\n        pagination: false,\n      })\n\n      const response = await fetch(`${baseAPIURL}/${addressesSlug}?${query}`, {\n        credentials: 'include',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        method: 'GET',\n      })\n\n      if (!response.ok) {\n        const errorText = await response.text()\n\n        throw new Error(errorText)\n      }\n\n      const data = await response.json()\n\n      if (data.error) {\n        throw new Error(`Address fetch error: ${data.error}`)\n      }\n\n      setAddresses(data.docs ?? [])\n    } catch (error) {\n      if (debug) {\n        // eslint-disable-next-line no-console\n        console.error('Error fetching addresses:', error)\n      }\n      setAddresses([])\n      // Don't rethrow - allow the operation to complete even if refresh fails\n    }\n  }, [user, baseAPIURL, addressesSlug, debug])\n\n  const updateAddress = useCallback<EcommerceContextType['updateAddress']>(\n    async (addressID, address) => {\n      if (!user) {\n        throw new Error('User must be logged in to update or create an address')\n      }\n\n      try {\n        const response = await fetch(`${baseAPIURL}/${addressesSlug}/${addressID}`, {\n          body: JSON.stringify(address),\n          credentials: 'include',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          method: 'PATCH',\n        })\n\n        if (!response.ok) {\n          const errorText = await response.text()\n          throw new Error(`Failed to update or create address: ${errorText}`)\n        }\n\n        const data = await response.json()\n\n        if (data.error) {\n          throw new Error(`Address update/create error: ${data.error}`)\n        }\n\n        // Refresh addresses after updating or creating\n        await getAddresses()\n      } catch (error) {\n        if (debug) {\n          // eslint-disable-next-line no-console\n          console.error('Error updating or creating address:', error)\n        }\n\n        throw new Error(\n          `Failed to update or create address: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        )\n      }\n    },\n    [user, baseAPIURL, addressesSlug, getAddresses, debug],\n  )\n\n  const createAddress = useCallback<EcommerceContextType['createAddress']>(\n    async (address) => {\n      if (!user) {\n        throw new Error('User must be logged in to update or create an address')\n      }\n\n      try {\n        const response = await fetch(`${baseAPIURL}/${addressesSlug}`, {\n          body: JSON.stringify(address),\n          credentials: 'include',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          method: 'POST',\n        })\n\n        if (!response.ok) {\n          const errorText = await response.text()\n          throw new Error(`Failed to update or create address: ${errorText}`)\n        }\n\n        const data = await response.json()\n\n        if (data.error) {\n          throw new Error(`Address update/create error: ${data.error}`)\n        }\n\n        // Refresh addresses after updating or creating\n        await getAddresses()\n      } catch (error) {\n        if (debug) {\n          // eslint-disable-next-line no-console\n          console.error('Error updating or creating address:', error)\n        }\n\n        throw new Error(\n          `Failed to update or create address: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        )\n      }\n    },\n    [user, baseAPIURL, addressesSlug, getAddresses, debug],\n  )\n\n  const deleteAddress = useCallback<EcommerceContextType['deleteAddress']>(\n    async (addressID) => {\n      if (!user) {\n        throw new Error('User must be logged in to delete an address')\n      }\n\n      try {\n        const response = await fetch(`${baseAPIURL}/${addressesSlug}/${addressID}`, {\n          credentials: 'include',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          method: 'DELETE',\n        })\n\n        if (!response.ok) {\n          const errorText = await response.text()\n          throw new Error(`Failed to delete address: ${errorText}`)\n        }\n\n        const data = await response.json()\n\n        if (data.error) {\n          throw new Error(`Address delete error: ${data.error}`)\n        }\n\n        // Refresh addresses after deleting\n        await getAddresses()\n      } catch (error) {\n        if (debug) {\n          // eslint-disable-next-line no-console\n          console.error('Error deleting address:', error)\n        }\n\n        throw new Error(\n          `Failed to delete address: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        )\n      }\n    },\n    [user, baseAPIURL, addressesSlug, getAddresses, debug],\n  )\n\n  /**\n   * Refresh the cart data from the server.\n   */\n  const refreshCart = useCallback<EcommerceContextType['refreshCart']>(async () => {\n    if (!cartID) {\n      return\n    }\n    const updatedCart = await getCart(cartID, { secret: cartSecret })\n    setCart(updatedCart)\n  }, [cartID, cartSecret, getCart])\n\n  /**\n   * Clears all ecommerce session data from state and localStorage.\n   * Used during logout to ensure no user data persists.\n   */\n  const clearSession = useCallback(() => {\n    setCart(undefined)\n    setCartID(undefined)\n    setCartSecret(undefined)\n    setAddresses(undefined)\n    setUser(null)\n\n    if (syncLocalStorage) {\n      localStorage.removeItem(localStorageConfig.key)\n      localStorage.removeItem(`${localStorageConfig.key}_secret`)\n    }\n  }, [localStorageConfig.key, syncLocalStorage])\n\n  /**\n   * Called during logout. Clears all session data.\n   */\n  const onLogout = useCallback(() => {\n    clearSession()\n  }, [clearSession])\n\n  /**\n   * Merges items from a source cart into a target cart.\n   * Useful for merging a guest cart into a user's existing cart after login.\n   */\n  const mergeCart = useCallback<EcommerceContextType['mergeCart']>(\n    async (targetCartID, sourceCartID, sourceSecret) => {\n      setIsLoading(true)\n      try {\n        const response = await fetch(`${baseAPIURL}/${cartsSlug}/${targetCartID}/merge`, {\n          body: JSON.stringify({\n            sourceCartID,\n            sourceSecret,\n          }),\n          credentials: 'include',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          method: 'POST',\n        })\n\n        if (!response.ok) {\n          const errorText = await response.text()\n          throw new Error(`Failed to merge carts: ${errorText}`)\n        }\n\n        const result = await response.json()\n\n        if (!result.success) {\n          throw new Error(result.message || 'Failed to merge carts')\n        }\n\n        // Refresh cart with proper depth/populate settings for UI\n        const refreshedCart = await getCart(targetCartID)\n        setCart(refreshedCart)\n        setCartID(targetCartID)\n\n        return refreshedCart\n      } catch (error) {\n        if (debug) {\n          // eslint-disable-next-line no-console\n          console.error('Error merging carts:', error)\n        }\n        throw error\n      } finally {\n        setIsLoading(false)\n      }\n    },\n    [baseAPIURL, cartsSlug, debug, getCart],\n  )\n\n  /**\n   * Called after login to properly set up cart state.\n   * Handles merging guest cart with user's existing cart if applicable.\n   */\n  const onLogin = useCallback(async () => {\n    // Store reference to any existing guest cart before fetching user\n    const guestCartID = cartID\n    const guestSecret = cartSecret\n\n    // Fetch fresh user data\n    const fetchedUser = await getUser()\n\n    if (!fetchedUser) {\n      // No user means login failed, keep current state\n      return\n    }\n\n    // Clear the guest cart secret - authenticated users don't need it\n    setCartSecret(undefined)\n    if (syncLocalStorage) {\n      localStorage.removeItem(`${localStorageConfig.key}_secret`)\n    }\n\n    // Check if user has an existing cart\n    const userCartID =\n      fetchedUser.cart?.docs && fetchedUser.cart.docs.length > 0\n        ? typeof fetchedUser.cart.docs[0] === 'object'\n          ? fetchedUser.cart.docs[0].id\n          : fetchedUser.cart.docs[0]\n        : undefined\n\n    if (guestCartID && guestSecret) {\n      // Guest had a cart - need to handle merge/transfer\n      if (userCartID) {\n        // User has existing cart - merge guest cart into user's cart\n        try {\n          await mergeCart(userCartID, guestCartID, guestSecret)\n        } catch (error) {\n          if (debug) {\n            // eslint-disable-next-line no-console\n            console.error('Error merging carts:', error)\n          }\n          // Fall back to user's cart\n          const userCart = await getCart(userCartID)\n          setCart(userCart)\n          setCartID(userCartID)\n        }\n      } else {\n        // User has no existing cart - transfer guest cart to user\n        try {\n          const response = await fetch(\n            `${baseAPIURL}/${cartsSlug}/${guestCartID}?secret=${guestSecret}`,\n            {\n              body: JSON.stringify({\n                customer: fetchedUser.id,\n                secret: null, // Clear the secret since it's now owned by user\n              }),\n              credentials: 'include',\n              headers: {\n                'Content-Type': 'application/json',\n              },\n              method: 'PATCH',\n            },\n          )\n\n          if (response.ok) {\n            // Fetch updated cart\n            const updatedCart = await getCart(guestCartID)\n            setCart(updatedCart)\n            setCartID(guestCartID)\n          }\n        } catch (error) {\n          if (debug) {\n            // eslint-disable-next-line no-console\n            console.error('Error transferring cart to user:', error)\n          }\n        }\n      }\n    } else if (userCartID) {\n      // No guest cart, but user has a cart - fetch it\n      const userCart = await getCart(userCartID)\n      setCart(userCart)\n      setCartID(userCartID)\n    }\n\n    // Update localStorage with user's cart ID (no secret needed)\n    if (syncLocalStorage && cartID) {\n      localStorage.setItem(localStorageConfig.key, cartID as string)\n    }\n  }, [\n    baseAPIURL,\n    cartID,\n    cartSecret,\n    cartsSlug,\n    debug,\n    getCart,\n    getUser,\n    localStorageConfig.key,\n    mergeCart,\n    syncLocalStorage,\n  ])\n\n  // If localStorage is enabled, restore cart from storage\n  useEffect(() => {\n    if (!hasRendered.current) {\n      if (syncLocalStorage) {\n        const storedCartID = localStorage.getItem(localStorageConfig.key)\n        const storedSecret = localStorage.getItem(`${localStorageConfig.key}_secret`)\n\n        if (storedCartID) {\n          getCart(storedCartID, { secret: storedSecret || undefined })\n            .then((fetchedCart) => {\n              setCart(fetchedCart)\n              setCartID(storedCartID as DefaultDocumentIDType)\n              if (storedSecret) {\n                setCartSecret(storedSecret)\n              }\n            })\n            .catch((_) => {\n              // console.error('Error fetching cart from localStorage:', error)\n              // If there's an error fetching the cart, clear it from localStorage\n              localStorage.removeItem(localStorageConfig.key)\n              localStorage.removeItem(`${localStorageConfig.key}_secret`)\n              setCartID(undefined)\n              setCart(undefined)\n              setCartSecret(undefined)\n            })\n        }\n      }\n\n      hasRendered.current = true\n\n      // Helper function to load user's cart\n      const loadUserCart = (userData: TypedUser) => {\n        if (userData.cart?.docs && userData.cart.docs.length > 0) {\n          const userCartID =\n            typeof userData.cart.docs[0] === 'object'\n              ? userData.cart.docs[0].id\n              : userData.cart.docs[0]\n\n          if (userCartID) {\n            getCart(userCartID)\n              .then((fetchedCart) => {\n                setCart(fetchedCart)\n                setCartID(userCartID)\n              })\n              .catch((error) => {\n                if (debug) {\n                  // eslint-disable-next-line no-console\n                  console.error('Error fetching user cart:', error)\n                }\n\n                setCart(undefined)\n                setCartID(undefined)\n\n                throw new Error(`Failed to fetch user cart: ${error.message}`)\n              })\n          }\n        }\n      }\n\n      // Fetch user from API\n      void getUser().then((fetchedUser) => {\n        if (fetchedUser) {\n          loadUserCart(fetchedUser)\n        }\n      })\n    }\n  }, [debug, getAddresses, getCart, getUser, localStorageConfig.key, syncLocalStorage])\n\n  useEffect(() => {\n    if (user) {\n      // If the user is logged in, fetch their addresses\n      void getAddresses()\n    } else {\n      // If no user is logged in, clear addresses\n      setAddresses(undefined)\n    }\n  }, [getAddresses, user])\n\n  return (\n    <EcommerceContext\n      value={{\n        addItem,\n        addresses,\n        cart,\n        cartID,\n        clearCart,\n        clearSession,\n        config,\n        confirmOrder,\n        createAddress,\n        currenciesConfig,\n        currency: selectedCurrency,\n        decrementItem,\n        deleteAddress,\n        incrementItem,\n        initiatePayment,\n        isLoading,\n        mergeCart,\n        onLogin,\n        onLogout,\n        paymentMethods,\n        refreshCart,\n        refreshUser,\n        removeItem,\n        selectedPaymentMethod,\n        setCurrency,\n        updateAddress,\n        user,\n      }}\n    >\n      {children}\n    </EcommerceContext>\n  )\n}\n\nexport const useEcommerce = () => {\n  const context = use(EcommerceContext)\n\n  if (!context) {\n    throw new Error('useEcommerce must be used within an EcommerceProvider')\n  }\n\n  return context\n}\n\nexport const useEcommerceConfig = () => {\n  const { config } = useEcommerce()\n\n  return config\n}\n\nexport const useCurrency = () => {\n  const { currenciesConfig, currency, setCurrency } = useEcommerce()\n\n  const formatCurrency = useCallback(\n    (value?: null | number, options?: { currency?: Currency }): string => {\n      if (value === undefined || value === null) {\n        return ''\n      }\n\n      const currencyToUse = options?.currency || currency\n\n      if (!currencyToUse) {\n        return value.toString()\n      }\n\n      if (value === 0) {\n        return `${currencyToUse.symbol}0.${'0'.repeat(currencyToUse.decimals)}`\n      }\n\n      // Convert from base value (e.g., cents) to decimal value (e.g., dollars)\n      const decimalValue = value / Math.pow(10, currencyToUse.decimals)\n\n      // Format with the correct number of decimal places\n      return `${currencyToUse.symbol}${decimalValue.toFixed(currencyToUse.decimals)}`\n    },\n    [currency],\n  )\n\n  if (!currency) {\n    throw new Error('useCurrency must be used within an EcommerceProvider')\n  }\n\n  return {\n    currency,\n    formatCurrency,\n    setCurrency,\n    supportedCurrencies: currenciesConfig.supportedCurrencies,\n  }\n}\n\nexport function useCart<T extends CartsCollection>() {\n  const { addItem, cart, clearCart, decrementItem, incrementItem, isLoading, removeItem } =\n    useEcommerce()\n\n  if (!addItem) {\n    throw new Error('useCart must be used within an EcommerceProvider')\n  }\n\n  return {\n    addItem,\n    cart: cart as T,\n    clearCart,\n    decrementItem,\n    incrementItem,\n    isLoading,\n    removeItem,\n  }\n}\n\nexport const usePayments = () => {\n  const { confirmOrder, initiatePayment, isLoading, paymentMethods, selectedPaymentMethod } =\n    useEcommerce()\n\n  if (!initiatePayment) {\n    throw new Error('usePayments must be used within an EcommerceProvider')\n  }\n\n  return { confirmOrder, initiatePayment, isLoading, paymentMethods, selectedPaymentMethod }\n}\n\nexport function useAddresses<T extends AddressesCollection>() {\n  const { addresses, createAddress, deleteAddress, isLoading, updateAddress } = useEcommerce()\n\n  if (!createAddress) {\n    throw new Error('useAddresses must be used within an EcommerceProvider')\n  }\n\n  return { addresses: addresses as T[], createAddress, deleteAddress, isLoading, updateAddress }\n}\n"],"names":["deepMergeSimple","formatAdminURL","qs","React","createContext","use","useCallback","useEffect","useMemo","useRef","useState","defaultContext","addItem","clearCart","clearSession","config","addressesSlug","api","apiRoute","cartsSlug","customersSlug","confirmOrder","createAddress","deleteAddress","currenciesConfig","defaultCurrency","supportedCurrencies","code","decimals","label","symbol","currency","decrementItem","incrementItem","initiatePayment","isLoading","mergeCart","onLogin","onLogout","paymentMethods","refreshCart","refreshUser","removeItem","setCurrency","updateAddress","user","EcommerceContext","defaultLocalStorage","key","EcommerceProvider","children","debug","syncLocalStorage","localStorageConfig","cartsFetchQuery","baseAPIURL","path","setIsLoading","setUser","addresses","setAddresses","hasRendered","cartID","setCartID","cartSecret","setCartSecret","undefined","cart","setCart","selectedCurrency","setSelectedCurrency","find","c","selectedPaymentMethod","setSelectedPaymentMethod","cartQuery","priceField","baseQuery","depth","populate","products","variants","options","select","items","subtotal","createCart","initialData","query","stringify","response","fetch","body","JSON","customer","id","credentials","headers","method","ok","errorText","text","Error","data","json","error","doc","secret","getCart","queryParams","updateCart","updatedCart","deleteCart","url","current","localStorage","setItem","item","quantity","result","success","refreshedCart","newCart","console","targetID","itemID","$inc","foundCurrency","paymentMethodID","paymentMethod","name","fetchURL","additionalData","responseError","responseData","message","pm","getUser","carts","userData","fetchedUser","docs","length","userCartID","fetchedCart","getAddresses","limit","pagination","addressID","address","targetCartID","sourceCartID","sourceSecret","guestCartID","guestSecret","userCart","storedCartID","getItem","storedSecret","then","catch","_","loadUserCart","value","useEcommerce","context","useEcommerceConfig","useCurrency","formatCurrency","currencyToUse","toString","repeat","decimalValue","Math","pow","toFixed","useCart","usePayments","useAddresses"],"mappings":"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"}