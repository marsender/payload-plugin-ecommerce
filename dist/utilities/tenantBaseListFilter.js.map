{"version":3,"sources":["../../src/utilities/tenantBaseListFilter.ts"],"sourcesContent":["import type { PayloadRequest, Where } from 'payload'\n\nimport { parseCookies } from 'payload'\n\ntype BaseFilterArgs = {\n  limit: number\n  locale?: string | null\n  page: number\n  req: PayloadRequest\n  sort: string\n}\n\ntype Props = {\n  /**\n   * Name of the array field containing user's tenant memberships.\n   * @default 'tenants'\n   */\n  tenantsArrayFieldName?: string\n  /**\n   * Name of the tenant field within the user's tenants array.\n   * @default 'tenant'\n   */\n  tenantsArrayTenantFieldName?: string\n  /**\n   * Name of the roles field within each tenant membership.\n   * @default 'roles'\n   */\n  tenantsArrayRolesFieldName?: string\n  /**\n   * Roles that grant super-admin access (bypass all tenant filtering).\n   * @default ['super-admin']\n   */\n  superAdminRoles?: string[]\n  /**\n   * Roles in tenant membership that grant tenant-admin access.\n   * @default ['tenant-admin']\n   */\n  tenantAdminRoles?: string[]\n}\n\n/**\n * Creates a baseListFilter function that filters carts by tenant in the admin list view.\n *\n * For admins:\n * - Super-admins see all carts\n * - Tenant-admins see carts from tenants where they have admin role\n *\n * For non-admins:\n * - Returns a filter that shows no results (they access carts via other means)\n */\nexport const tenantBaseListFilter = ({\n  tenantsArrayFieldName = 'tenants',\n  tenantsArrayTenantFieldName = 'tenant',\n  tenantsArrayRolesFieldName = 'roles',\n  superAdminRoles = ['super-admin'],\n  tenantAdminRoles = ['tenant-admin'],\n}: Props = {}) => {\n  return ({ req }: BaseFilterArgs): Where => {\n    const user = req.user as Record<string, unknown> | null\n\n    // No user - no access\n    if (!user) {\n      return { id: { equals: -1 } }\n    }\n\n    // Check for selected tenant in cookies (admin panel context)\n    const cookies = parseCookies(req.headers)\n    const selectedTenant = cookies.get('payload-tenant')\n    const selectedTenantId = selectedTenant ? (Number(selectedTenant) || selectedTenant) : null\n\n    // Check super-admin FIRST (before other checks)\n    const roles = user.roles as string[] | undefined\n    if (roles?.some((role) => superAdminRoles.includes(role))) {\n      // Super-admins: filter by selected tenant if one is chosen\n      if (selectedTenantId) {\n        return { tenant: { equals: selectedTenantId } }\n      }\n      return {} // No tenant selected - see all\n    }\n\n    // Get user's tenant memberships and check for tenant-admin roles\n    const adminTenantIds: (string | number)[] = []\n    const tenantsArray = user[tenantsArrayFieldName] as\n      | Array<{ [key: string]: unknown }>\n      | undefined\n\n    if (Array.isArray(tenantsArray)) {\n      for (const membership of tenantsArray) {\n        const tenantValue = membership[tenantsArrayTenantFieldName]\n        const membershipRoles = membership[tenantsArrayRolesFieldName] as string[] | undefined\n\n        // Check if user has tenant-admin role in this membership\n        const hasTenantAdminRole = membershipRoles?.some((role) => tenantAdminRoles.includes(role))\n\n        if (tenantValue && hasTenantAdminRole) {\n          const tenantId =\n            typeof tenantValue === 'object' && tenantValue !== null && 'id' in tenantValue\n              ? (tenantValue as { id: string | number }).id\n              : tenantValue\n          if (tenantId) {\n            adminTenantIds.push(tenantId as string | number)\n          }\n        }\n      }\n    }\n\n    // If user has tenant-admin role in any tenant, filter to those tenants\n    if (adminTenantIds.length > 0) {\n      // If admin has selected a specific tenant they have access to, filter to that tenant\n      if (selectedTenantId && adminTenantIds.includes(selectedTenantId)) {\n        return { tenant: { equals: selectedTenantId } }\n      }\n\n      // Return filter for user's admin tenants\n      return { tenant: { in: adminTenantIds } }\n    }\n\n    // Not a tenant admin - return filter that shows no results\n    // (regular users access their carts via API, not admin list)\n    return { id: { equals: -1 } }\n  }\n}\n"],"names":["parseCookies","tenantBaseListFilter","tenantsArrayFieldName","tenantsArrayTenantFieldName","tenantsArrayRolesFieldName","superAdminRoles","tenantAdminRoles","req","user","id","equals","cookies","headers","selectedTenant","get","selectedTenantId","Number","roles","some","role","includes","tenant","adminTenantIds","tenantsArray","Array","isArray","membership","tenantValue","membershipRoles","hasTenantAdminRole","tenantId","push","length","in"],"mappings":"AAEA,SAASA,YAAY,QAAQ,UAAS;AAsCtC;;;;;;;;;CASC,GACD,OAAO,MAAMC,uBAAuB,CAAC,EACnCC,wBAAwB,SAAS,EACjCC,8BAA8B,QAAQ,EACtCC,6BAA6B,OAAO,EACpCC,kBAAkB;IAAC;CAAc,EACjCC,mBAAmB;IAAC;CAAe,EAC7B,GAAG,CAAC,CAAC;IACX,OAAO,CAAC,EAAEC,GAAG,EAAkB;QAC7B,MAAMC,OAAOD,IAAIC,IAAI;QAErB,sBAAsB;QACtB,IAAI,CAACA,MAAM;YACT,OAAO;gBAAEC,IAAI;oBAAEC,QAAQ,CAAC;gBAAE;YAAE;QAC9B;QAEA,6DAA6D;QAC7D,MAAMC,UAAUX,aAAaO,IAAIK,OAAO;QACxC,MAAMC,iBAAiBF,QAAQG,GAAG,CAAC;QACnC,MAAMC,mBAAmBF,iBAAkBG,OAAOH,mBAAmBA,iBAAkB;QAEvF,gDAAgD;QAChD,MAAMI,QAAQT,KAAKS,KAAK;QACxB,IAAIA,OAAOC,KAAK,CAACC,OAASd,gBAAgBe,QAAQ,CAACD,QAAQ;YACzD,2DAA2D;YAC3D,IAAIJ,kBAAkB;gBACpB,OAAO;oBAAEM,QAAQ;wBAAEX,QAAQK;oBAAiB;gBAAE;YAChD;YACA,OAAO,CAAC,EAAE,+BAA+B;;QAC3C;QAEA,iEAAiE;QACjE,MAAMO,iBAAsC,EAAE;QAC9C,MAAMC,eAAef,IAAI,CAACN,sBAAsB;QAIhD,IAAIsB,MAAMC,OAAO,CAACF,eAAe;YAC/B,KAAK,MAAMG,cAAcH,aAAc;gBACrC,MAAMI,cAAcD,UAAU,CAACvB,4BAA4B;gBAC3D,MAAMyB,kBAAkBF,UAAU,CAACtB,2BAA2B;gBAE9D,yDAAyD;gBACzD,MAAMyB,qBAAqBD,iBAAiBV,KAAK,CAACC,OAASb,iBAAiBc,QAAQ,CAACD;gBAErF,IAAIQ,eAAeE,oBAAoB;oBACrC,MAAMC,WACJ,OAAOH,gBAAgB,YAAYA,gBAAgB,QAAQ,QAAQA,cAC/D,AAACA,YAAwClB,EAAE,GAC3CkB;oBACN,IAAIG,UAAU;wBACZR,eAAeS,IAAI,CAACD;oBACtB;gBACF;YACF;QACF;QAEA,uEAAuE;QACvE,IAAIR,eAAeU,MAAM,GAAG,GAAG;YAC7B,qFAAqF;YACrF,IAAIjB,oBAAoBO,eAAeF,QAAQ,CAACL,mBAAmB;gBACjE,OAAO;oBAAEM,QAAQ;wBAAEX,QAAQK;oBAAiB;gBAAE;YAChD;YAEA,yCAAyC;YACzC,OAAO;gBAAEM,QAAQ;oBAAEY,IAAIX;gBAAe;YAAE;QAC1C;QAEA,2DAA2D;QAC3D,6DAA6D;QAC7D,OAAO;YAAEb,IAAI;gBAAEC,QAAQ,CAAC;YAAE;QAAE;IAC9B;AACF,EAAC"}