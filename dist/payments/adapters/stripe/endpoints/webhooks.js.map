{"version":3,"sources":["../../../../../src/payments/adapters/stripe/endpoints/webhooks.ts"],"sourcesContent":["import type { Endpoint } from 'payload'\n\nimport Stripe from 'stripe'\n\nimport type { StripeAdapterArgs } from '../index.js'\n\ntype Props = {\n\tapiVersion?: Stripe.StripeConfig['apiVersion']\n\tappInfo?: Stripe.StripeConfig['appInfo']\n\tsecretKey: StripeAdapterArgs['secretKey']\n\twebhooks?: StripeAdapterArgs['webhooks']\n\twebhookSecret: StripeAdapterArgs['webhookSecret']\n}\n\nexport const webhooksEndpoint: (props: Props) => Endpoint = (props) => {\n\tconst { apiVersion, appInfo, secretKey, webhooks, webhookSecret } = props || {}\n\n\tconst handler: Endpoint['handler'] = async (req) => {\n\t\tlet returnStatus = 200\n\n\t\tlet resolvedSecretKey = secretKey\n\t\tif (typeof secretKey === 'function') {\n\t\t\tresolvedSecretKey = await secretKey({ req })\n\t\t}\n\n\t\tlet resolvedWebhookSecret = webhookSecret\n\t\tif (typeof webhookSecret === 'function') {\n\t\t\tresolvedWebhookSecret = await webhookSecret({ req })\n\t\t}\n\n\t\tif (resolvedWebhookSecret && resolvedSecretKey && req.text) {\n\t\t\tconst stripe = new Stripe(resolvedSecretKey as string, {\n\t\t\t\t// API version can only be the latest, stripe recommends ts ignoring it\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n\t\t\t\t// @ts-ignore - ignoring since possible versions are not type safe, only the latest version is recognised\n\t\t\t\tapiVersion: apiVersion || '2025-09-30.clover',\n\t\t\t\tappInfo: appInfo || {\n\t\t\t\t\tname: 'Stripe Payload Plugin',\n\t\t\t\t\turl: 'https://payloadcms.com',\n\t\t\t\t},\n\t\t\t})\n\n\t\t\tconst body = await req.text()\n\t\t\tconst stripeSignature = req.headers.get('stripe-signature')\n\n\t\t\tif (stripeSignature) {\n\t\t\t\tlet event: Stripe.Event | undefined\n\n\t\t\t\ttry {\n\t\t\t\t\tevent = stripe.webhooks.constructEvent(body, stripeSignature, resolvedWebhookSecret as string)\n\t\t\t\t} catch (err: unknown) {\n\t\t\t\t\tconst msg: string = err instanceof Error ? err.message : JSON.stringify(err)\n\t\t\t\t\treq.payload.logger.error(`Error constructing Stripe event: ${msg}`)\n\t\t\t\t\treturnStatus = 400\n\t\t\t\t}\n\n\t\t\t\tif (typeof webhooks === 'object' && event) {\n\t\t\t\t\tconst webhookEventHandler = webhooks[event.type]\n\n\t\t\t\t\tif (typeof webhookEventHandler === 'function') {\n\t\t\t\t\t\tawait webhookEventHandler({\n\t\t\t\t\t\t\tevent,\n\t\t\t\t\t\t\treq,\n\t\t\t\t\t\t\tstripe,\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn Response.json({ received: true }, { status: returnStatus })\n\t}\n\n\treturn {\n\t\thandler,\n\t\tmethod: 'post',\n\t\tpath: '/webhooks',\n\t}\n}\n"],"names":["Stripe","webhooksEndpoint","props","apiVersion","appInfo","secretKey","webhooks","webhookSecret","handler","req","returnStatus","resolvedSecretKey","resolvedWebhookSecret","text","stripe","name","url","body","stripeSignature","headers","get","event","constructEvent","err","msg","Error","message","JSON","stringify","payload","logger","error","webhookEventHandler","type","Response","json","received","status","method","path"],"mappings":"AAEA,OAAOA,YAAY,SAAQ;AAY3B,OAAO,MAAMC,mBAA+C,CAACC;IAC5D,MAAM,EAAEC,UAAU,EAAEC,OAAO,EAAEC,SAAS,EAAEC,QAAQ,EAAEC,aAAa,EAAE,GAAGL,SAAS,CAAC;IAE9E,MAAMM,UAA+B,OAAOC;QAC3C,IAAIC,eAAe;QAEnB,IAAIC,oBAAoBN;QACxB,IAAI,OAAOA,cAAc,YAAY;YACpCM,oBAAoB,MAAMN,UAAU;gBAAEI;YAAI;QAC3C;QAEA,IAAIG,wBAAwBL;QAC5B,IAAI,OAAOA,kBAAkB,YAAY;YACxCK,wBAAwB,MAAML,cAAc;gBAAEE;YAAI;QACnD;QAEA,IAAIG,yBAAyBD,qBAAqBF,IAAII,IAAI,EAAE;YAC3D,MAAMC,SAAS,IAAId,OAAOW,mBAA6B;gBACtD,uEAAuE;gBACvE,6DAA6D;gBAC7D,yGAAyG;gBACzGR,YAAYA,cAAc;gBAC1BC,SAASA,WAAW;oBACnBW,MAAM;oBACNC,KAAK;gBACN;YACD;YAEA,MAAMC,OAAO,MAAMR,IAAII,IAAI;YAC3B,MAAMK,kBAAkBT,IAAIU,OAAO,CAACC,GAAG,CAAC;YAExC,IAAIF,iBAAiB;gBACpB,IAAIG;gBAEJ,IAAI;oBACHA,QAAQP,OAAOR,QAAQ,CAACgB,cAAc,CAACL,MAAMC,iBAAiBN;gBAC/D,EAAE,OAAOW,KAAc;oBACtB,MAAMC,MAAcD,eAAeE,QAAQF,IAAIG,OAAO,GAAGC,KAAKC,SAAS,CAACL;oBACxEd,IAAIoB,OAAO,CAACC,MAAM,CAACC,KAAK,CAAC,CAAC,iCAAiC,EAAEP,KAAK;oBAClEd,eAAe;gBAChB;gBAEA,IAAI,OAAOJ,aAAa,YAAYe,OAAO;oBAC1C,MAAMW,sBAAsB1B,QAAQ,CAACe,MAAMY,IAAI,CAAC;oBAEhD,IAAI,OAAOD,wBAAwB,YAAY;wBAC9C,MAAMA,oBAAoB;4BACzBX;4BACAZ;4BACAK;wBACD;oBACD;gBACD;YACD;QACD;QAEA,OAAOoB,SAASC,IAAI,CAAC;YAAEC,UAAU;QAAK,GAAG;YAAEC,QAAQ3B;QAAa;IACjE;IAEA,OAAO;QACNF;QACA8B,QAAQ;QACRC,MAAM;IACP;AACD,EAAC"}