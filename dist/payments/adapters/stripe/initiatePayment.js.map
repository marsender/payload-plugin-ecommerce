{"version":3,"sources":["../../../../src/payments/adapters/stripe/initiatePayment.ts"],"sourcesContent":["import Stripe from 'stripe'\n\nimport type { PaymentAdapter } from '../../../types/index.js'\nimport type {\n  InitiatePaymentReturnType,\n  ResolveConnectedAccountFn,\n  StripeAdapterArgs,\n} from './index.js'\n\ntype Props = {\n  apiVersion?: Stripe.StripeConfig['apiVersion']\n  appInfo?: Stripe.StripeConfig['appInfo']\n  resolveConnectedAccount?: ResolveConnectedAccountFn\n  secretKey: StripeAdapterArgs['secretKey']\n}\n\nexport const initiatePayment: (props: Props) => NonNullable<PaymentAdapter>['initiatePayment'] =\n  (props) =>\n  async ({ data, req, transactionsSlug }) => {\n    const payload = req.payload\n    const { apiVersion, appInfo, resolveConnectedAccount, secretKey } = props || {}\n\n    const customerEmail = data.customerEmail\n    const currency = data.currency\n    const cart = data.cart\n    const amount = cart.subtotal\n    const billingAddressFromData = data.billingAddress\n    const shippingAddressFromData = data.shippingAddress\n\n    if (!secretKey) {\n      throw new Error('Stripe secret key is required.')\n    }\n\n    if (!currency) {\n      throw new Error('Currency is required.')\n    }\n\n    if (!cart || !cart.items || cart.items.length === 0) {\n      throw new Error('Cart is empty or not provided.')\n    }\n\n    if (!customerEmail || typeof customerEmail !== 'string') {\n      throw new Error('A valid customer email is required to make a purchase.')\n    }\n\n    if (!amount || typeof amount !== 'number' || amount <= 0) {\n      throw new Error('A valid amount is required to initiate a payment.')\n    }\n\n    const stripe = new Stripe(secretKey, {\n      // API version can only be the latest, stripe recommends ts ignoring it\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore - ignoring since possible versions are not type safe, only the latest version is recognised\n      apiVersion: apiVersion || '2025-09-30.clover',\n      appInfo: appInfo || {\n        name: 'Stripe Payload Plugin',\n        url: 'https://payloadcms.com',\n      },\n    })\n\n    try {\n      let customer = (\n        await stripe.customers.list({\n          email: customerEmail,\n        })\n      ).data[0]\n\n      if (!customer?.id) {\n        customer = await stripe.customers.create({\n          email: customerEmail,\n        })\n      }\n\n      const flattenedCart = cart.items.map((item) => {\n        const productID = typeof item.product === 'object' ? item.product.id : item.product\n        const variantID = item.variant\n          ? typeof item.variant === 'object'\n            ? item.variant.id\n            : item.variant\n          : undefined\n\n        return {\n          product: productID,\n          quantity: item.quantity,\n          variant: variantID,\n        }\n      })\n\n      const shippingAddressAsString = JSON.stringify(shippingAddressFromData)\n\n      // Resolve the connected account ID if the resolver function is provided\n      let connectedAccountId: string | undefined\n      if (resolveConnectedAccount) {\n        connectedAccountId = await resolveConnectedAccount({ cart, req })\n      }\n\n      // Build the PaymentIntent create params\n      const paymentIntentParams: Stripe.PaymentIntentCreateParams = {\n        amount,\n        automatic_payment_methods: {\n          enabled: true,\n        },\n        currency,\n        customer: customer.id,\n        metadata: {\n          cartID: cart.id,\n          cartItemsSnapshot: JSON.stringify(flattenedCart),\n          shippingAddress: shippingAddressAsString,\n          ...(connectedAccountId && { connectedAccountId }),\n        },\n      }\n\n      // Add Stripe Connect transfer_data if a connected account is resolved\n      if (connectedAccountId) {\n        paymentIntentParams.transfer_data = {\n          destination: connectedAccountId,\n        }\n      }\n\n      const paymentIntent = await stripe.paymentIntents.create(paymentIntentParams)\n\n      // Extract tenant from cart for multi-tenant support\n      // @ts-expect-error - tenant field may be added by multi-tenant plugin\n      const cartTenant = typeof cart.tenant === 'object' ? cart.tenant?.id : cart.tenant\n\n      // Create a transaction for the payment intent in the database\n      await payload.create({\n        collection: transactionsSlug,\n        data: {\n          ...(req.user ? { customer: req.user.id } : { customerEmail }),\n          amount: paymentIntent.amount,\n          billingAddress: billingAddressFromData,\n          cart: cart.id,\n          currency: paymentIntent.currency.toUpperCase(),\n          items: flattenedCart,\n          paymentMethod: 'stripe',\n          status: 'pending',\n          stripe: {\n            customerID: customer.id,\n            paymentIntentID: paymentIntent.id,\n            ...(connectedAccountId && { connectedAccountId }),\n          },\n          ...(cartTenant && { tenant: cartTenant }),\n        },\n      })\n\n      const returnData: InitiatePaymentReturnType = {\n        clientSecret: paymentIntent.client_secret || '',\n        message: 'Payment initiated successfully',\n        paymentIntentID: paymentIntent.id,\n      }\n\n      return returnData\n    } catch (error) {\n      payload.logger.error(error, 'Error initiating payment with Stripe')\n\n      throw new Error(error instanceof Error ? error.message : 'Unknown error initiating payment')\n    }\n  }\n"],"names":["Stripe","initiatePayment","props","data","req","transactionsSlug","payload","apiVersion","appInfo","resolveConnectedAccount","secretKey","customerEmail","currency","cart","amount","subtotal","billingAddressFromData","billingAddress","shippingAddressFromData","shippingAddress","Error","items","length","stripe","name","url","customer","customers","list","email","id","create","flattenedCart","map","item","productID","product","variantID","variant","undefined","quantity","shippingAddressAsString","JSON","stringify","connectedAccountId","paymentIntentParams","automatic_payment_methods","enabled","metadata","cartID","cartItemsSnapshot","transfer_data","destination","paymentIntent","paymentIntents","cartTenant","tenant","collection","user","toUpperCase","paymentMethod","status","customerID","paymentIntentID","returnData","clientSecret","client_secret","message","error","logger"],"mappings":"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"}