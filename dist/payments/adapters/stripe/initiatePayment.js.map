{"version":3,"sources":["../../../../src/payments/adapters/stripe/initiatePayment.ts"],"sourcesContent":["import Stripe from 'stripe'\n\nimport type { PaymentAdapter } from '../../../types/index.js'\nimport type { InitiatePaymentReturnType, ResolveConnectedAccountFn, StripeAdapterArgs } from './index.js'\n\ntype Props = {\n\tapiVersion?: Stripe.StripeConfig['apiVersion']\n\tappInfo?: Stripe.StripeConfig['appInfo']\n\tresolveConnectedAccount?: ResolveConnectedAccountFn\n\tsecretKey: StripeAdapterArgs['secretKey']\n}\n\nexport const initiatePayment: (props: Props) => NonNullable<PaymentAdapter>['initiatePayment'] =\n\t(props) =>\n\tasync ({ data, req, transactionsSlug }) => {\n\t\tconst payload = req.payload\n\t\tconst { apiVersion, appInfo, resolveConnectedAccount, secretKey } = props || {}\n\n\t\tconst customerEmail = data.customerEmail\n\t\tconst currency = data.currency\n\t\tconst cart = data.cart\n\t\tconst amount = cart.subtotal\n\t\tconst billingAddressFromData = data.billingAddress\n\t\tconst shippingAddressFromData = data.shippingAddress\n\n\t\tlet resolvedSecretKey = secretKey\n\t\tif (typeof secretKey === 'function') {\n\t\t\tresolvedSecretKey = await secretKey({ req })\n\t\t}\n\n\t\tif (!resolvedSecretKey) {\n\t\t\tthrow new Error('Stripe secret key is required.')\n\t\t}\n\n\t\tif (!currency) {\n\t\t\tthrow new Error('Currency is required.')\n\t\t}\n\n\t\tif (!cart || !cart.items || cart.items.length === 0) {\n\t\t\tthrow new Error('Cart is empty or not provided.')\n\t\t}\n\n\t\tif (!customerEmail || typeof customerEmail !== 'string') {\n\t\t\tthrow new Error('A valid customer email is required to make a purchase.')\n\t\t}\n\n\t\tif (!amount || typeof amount !== 'number' || amount <= 0) {\n\t\t\tthrow new Error('A valid amount is required to initiate a payment.')\n\t\t}\n\n\t\tconst stripe = new Stripe(resolvedSecretKey as string, {\n\t\t\t// API version can only be the latest, stripe recommends ts ignoring it\n\t\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n\t\t\t// @ts-ignore - ignoring since possible versions are not type safe, only the latest version is recognised\n\t\t\tapiVersion: apiVersion || '2025-09-30.clover',\n\t\t\tappInfo: appInfo || {\n\t\t\t\tname: 'Stripe Payload Plugin',\n\t\t\t\turl: 'https://payloadcms.com',\n\t\t\t},\n\t\t})\n\n\t\ttry {\n\t\t\tlet customer = (\n\t\t\t\tawait stripe.customers.list({\n\t\t\t\t\temail: customerEmail,\n\t\t\t\t})\n\t\t\t).data[0]\n\n\t\t\tif (!customer?.id) {\n\t\t\t\tcustomer = await stripe.customers.create({\n\t\t\t\t\temail: customerEmail,\n\t\t\t\t})\n\t\t\t}\n\n\t\t\tconst flattenedCart = cart.items.map((item) => {\n\t\t\tconst productID = typeof item.product === 'object' ? item.product.id : item.product\n\t\t\tconst variantID =\n\t\t\t\titem.variant ?\n\t\t\t\t\ttypeof item.variant === 'object' ?\n\t\t\t\t\t\titem.variant.id\n\t\t\t\t\t:\titem.variant\n\t\t\t\t:\tundefined\n\n\t\t\t// Preserve any additional custom properties (e.g., deliveryOption, customizations)\n\t\t\t// that may have been added via cartItemMatcher\n\t\t\tconst { product: _product, variant: _variant, ...customProperties } = item\n\n\t\t\treturn {\n\t\t\t\t...customProperties,\n\t\t\t\tproduct: productID,\n\t\t\t\tquantity: item.quantity,\n\t\t\t\t...(variantID ? { variant: variantID } : {}),\n\t\t\t}\n\t\t})\n\n\t\t\tconst shippingAddressAsString = JSON.stringify(shippingAddressFromData)\n\n\t\t\t// Resolve the connected account ID if the resolver function is provided\n\t\t\tlet connectedAccountId: string | undefined\n\t\t\tif (resolveConnectedAccount) {\n\t\t\t\tconnectedAccountId = await resolveConnectedAccount({ cart, req })\n\t\t\t}\n\n\t\t\t// Build the PaymentIntent create params\n\t\t\tconst paymentIntentParams: Stripe.PaymentIntentCreateParams = {\n\t\t\t\tamount,\n\t\t\t\tautomatic_payment_methods: {\n\t\t\t\t\tenabled: true,\n\t\t\t\t},\n\t\t\t\tcurrency,\n\t\t\t\tcustomer: customer.id,\n\t\t\t\tmetadata: {\n\t\t\t\t\tcartID: cart.id,\n\t\t\t\t\tcartItemsSnapshot: JSON.stringify(flattenedCart),\n\t\t\t\t\tshippingAddress: shippingAddressAsString,\n\t\t\t\t\t...(connectedAccountId && { connectedAccountId }),\n\t\t\t\t},\n\t\t\t}\n\n\t\t\t// Add Stripe Connect transfer_data if a connected account is resolved\n\t\t\tif (connectedAccountId) {\n\t\t\t\tpaymentIntentParams.transfer_data = {\n\t\t\t\t\tdestination: connectedAccountId,\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst paymentIntent = await stripe.paymentIntents.create(paymentIntentParams)\n\n\t\t\t// Extract tenant from cart for multi-tenant support\n\t\t\t// @ts-expect-error - tenant field may be added by multi-tenant plugin\n\t\t\tconst cartTenant = typeof cart.tenant === 'object' ? cart.tenant?.id : cart.tenant\n\n\t\t\t// Create a transaction for the payment intent in the database\n\t\t\tawait payload.create({\n\t\t\t\tcollection: transactionsSlug,\n\t\t\t\treq,\n\t\t\t\tdata: {\n\t\t\t\t\t...(req.user ? { customer: req.user.id } : { customerEmail }),\n\t\t\t\t\tamount: paymentIntent.amount,\n\t\t\t\t\tbillingAddress: billingAddressFromData,\n\t\t\t\t\tcart: cart.id,\n\t\t\t\t\tcurrency: paymentIntent.currency.toUpperCase(),\n\t\t\t\t\titems: flattenedCart,\n\t\t\t\t\tpaymentMethod: 'stripe',\n\t\t\t\t\tstatus: 'pending',\n\t\t\t\t\tstripe: {\n\t\t\t\t\t\tcustomerID: customer.id,\n\t\t\t\t\t\tpaymentIntentID: paymentIntent.id,\n\t\t\t\t\t\t...(connectedAccountId && { connectedAccountId }),\n\t\t\t\t\t},\n\t\t\t\t\t...(cartTenant && { tenant: cartTenant }),\n\t\t\t\t},\n\t\t\t})\n\n\t\t\tconst returnData: InitiatePaymentReturnType = {\n\t\t\t\tclientSecret: paymentIntent.client_secret || '',\n\t\t\t\tmessage: 'Payment initiated successfully',\n\t\t\t\tpaymentIntentID: paymentIntent.id,\n\t\t\t}\n\n\t\t\treturn returnData\n\t\t} catch (error) {\n\t\t\tpayload.logger.error(error, 'Error initiating payment with Stripe')\n\n\t\t\tthrow new Error(error instanceof Error ? error.message : 'Unknown error initiating payment')\n\t\t}\n\t}\n"],"names":["Stripe","initiatePayment","props","data","req","transactionsSlug","payload","apiVersion","appInfo","resolveConnectedAccount","secretKey","customerEmail","currency","cart","amount","subtotal","billingAddressFromData","billingAddress","shippingAddressFromData","shippingAddress","resolvedSecretKey","Error","items","length","stripe","name","url","customer","customers","list","email","id","create","flattenedCart","map","item","productID","product","variantID","variant","undefined","_product","_variant","customProperties","quantity","shippingAddressAsString","JSON","stringify","connectedAccountId","paymentIntentParams","automatic_payment_methods","enabled","metadata","cartID","cartItemsSnapshot","transfer_data","destination","paymentIntent","paymentIntents","cartTenant","tenant","collection","user","toUpperCase","paymentMethod","status","customerID","paymentIntentID","returnData","clientSecret","client_secret","message","error","logger"],"mappings":"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"}