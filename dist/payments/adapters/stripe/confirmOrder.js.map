{"version":3,"sources":["../../../../src/payments/adapters/stripe/confirmOrder.ts"],"sourcesContent":["import Stripe from 'stripe'\n\nimport type { PaymentAdapter } from '../../../types/index.js'\nimport type { StripeAdapterArgs } from './index.js'\n\ntype Props = {\n\tapiVersion?: Stripe.StripeConfig['apiVersion']\n\tappInfo?: Stripe.StripeConfig['appInfo']\n\tsecretKey: StripeAdapterArgs['secretKey']\n}\n\nexport const confirmOrder: (props: Props) => NonNullable<PaymentAdapter>['confirmOrder'] =\n\t(props) =>\n\tasync ({ data, ordersSlug = 'orders', req, transactionsSlug = 'transactions' }) => {\n\t\tconst payload = req.payload\n\t\tconst { apiVersion, appInfo, secretKey } = props || {}\n\n\t\tconst customerEmail = data.customerEmail\n\n\t\tconst paymentIntentID = data.paymentIntentID as string\n\n\t\tif (!secretKey) {\n\t\t\tthrow new Error('Stripe secret key is required')\n\t\t}\n\n\t\tif (!paymentIntentID) {\n\t\t\tthrow new Error('PaymentIntent ID is required')\n\t\t}\n\n\t\tconst stripe = new Stripe(secretKey, {\n\t\t\t// API version can only be the latest, stripe recommends ts ignoring it\n\t\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n\t\t\t// @ts-ignore - ignoring since possible versions are not type safe, only the latest version is recognised\n\t\t\tapiVersion: apiVersion || '2025-09-30.clover',\n\t\t\tappInfo: appInfo || {\n\t\t\t\tname: 'Stripe Payload Plugin',\n\t\t\t\turl: 'https://payloadcms.com',\n\t\t\t},\n\t\t})\n\n\t\ttry {\n\t\t\tlet customer = (\n\t\t\t\tawait stripe.customers.list({\n\t\t\t\t\temail: customerEmail,\n\t\t\t\t})\n\t\t\t).data[0]\n\n\t\t\tif (!customer?.id) {\n\t\t\t\tcustomer = await stripe.customers.create({\n\t\t\t\t\temail: customerEmail,\n\t\t\t\t})\n\t\t\t}\n\n\t\t\t// Find our existing transaction by the payment intent ID\n\t\t\tconst transactionsResults = await payload.find({\n\t\t\t\tcollection: transactionsSlug,\n\t\t\t\twhere: {\n\t\t\t\t\t'stripe.paymentIntentID': {\n\t\t\t\t\t\tequals: paymentIntentID,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t})\n\n\t\t\tconst transaction = transactionsResults.docs[0]\n\n\t\t\tif (!transactionsResults.totalDocs || !transaction) {\n\t\t\t\tthrow new Error('No transaction found for the provided PaymentIntent ID')\n\t\t\t}\n\n\t\t\t// Verify the payment intent exists and retrieve it\n\t\t\tconst paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentID)\n\n\t\t\tconst cartID = paymentIntent.metadata.cartID\n\t\t\tconst cartItemsSnapshot = paymentIntent.metadata.cartItemsSnapshot ? JSON.parse(paymentIntent.metadata.cartItemsSnapshot) : undefined\n\n\t\t\tconst shippingAddress = paymentIntent.metadata.shippingAddress ? JSON.parse(paymentIntent.metadata.shippingAddress) : undefined\n\n\t\t\tif (!cartID) {\n\t\t\t\tthrow new Error('Cart ID not found in the PaymentIntent metadata')\n\t\t\t}\n\n\t\t\tif (!cartItemsSnapshot || !Array.isArray(cartItemsSnapshot)) {\n\t\t\t\tthrow new Error('Cart items snapshot not found or invalid in the PaymentIntent metadata')\n\t\t\t}\n\n\t\t\t// Fetch the cart to get the tenant (needed for multi-tenant support)\n\t\t\tconst cart = await payload.findByID({\n\t\t\t\tcollection: 'carts',\n\t\t\t\tid: cartID,\n\t\t\t\tselect: {\n\t\t\t\t\tid: true,\n\t\t\t\t\ttenant: true,\n\t\t\t\t},\n\t\t\t})\n\n\t\t\tif (!cart) {\n\t\t\t\tthrow new Error(`Cart with ID ${cartID} not found`)\n\t\t\t}\n\n\t\t\t// Extract tenant from cart for multi-tenant support\n\t\t\t// @ts-expect-error - tenant field may be added by multi-tenant plugin\n\t\t\tconst cartTenant = typeof cart.tenant === 'object' ? cart.tenant?.id : cart.tenant\n\n\t\t\tif (!cartTenant) {\n\t\t\t\tthrow new Error(`Cart ${cartID} has no tenant assigned`)\n\t\t\t}\n\n\t\t\tconst order = await payload.create({\n\t\t\t\tcollection: ordersSlug,\n\t\t\t\tdata: {\n\t\t\t\t\tamount: paymentIntent.amount,\n\t\t\t\t\tcurrency: paymentIntent.currency.toUpperCase(),\n\t\t\t\t\t...(req.user ? { customer: req.user.id } : { customerEmail }),\n\t\t\t\t\titems: cartItemsSnapshot,\n\t\t\t\t\tshippingAddress,\n\t\t\t\t\tstatus: 'processing',\n\t\t\t\t\ttransactions: [transaction.id],\n\t\t\t\t\ttenant: cartTenant,\n\t\t\t\t},\n\t\t\t})\n\n\t\t\tconst timestamp = new Date().toISOString()\n\n\t\t\tawait payload.update({\n\t\t\t\tid: cartID,\n\t\t\t\tcollection: 'carts',\n\t\t\t\tdata: {\n\t\t\t\t\tpurchasedAt: timestamp,\n\t\t\t\t},\n\t\t\t})\n\n\t\t\tawait payload.update({\n\t\t\t\tid: transaction.id,\n\t\t\t\tcollection: transactionsSlug,\n\t\t\t\tdata: {\n\t\t\t\t\torder: order.id,\n\t\t\t\t\tstatus: 'succeeded',\n\t\t\t\t},\n\t\t\t})\n\n\t\t\treturn {\n\t\t\t\tmessage: 'Payment initiated successfully',\n\t\t\t\torderID: order.id,\n\t\t\t\ttransactionID: transaction.id,\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tpayload.logger.error(error, 'Error initiating payment with Stripe')\n\n\t\t\tthrow new Error(error instanceof Error ? error.message : 'Unknown error initiating payment')\n\t\t}\n\t}\n"],"names":["Stripe","confirmOrder","props","data","ordersSlug","req","transactionsSlug","payload","apiVersion","appInfo","secretKey","customerEmail","paymentIntentID","Error","stripe","name","url","customer","customers","list","email","id","create","transactionsResults","find","collection","where","equals","transaction","docs","totalDocs","paymentIntent","paymentIntents","retrieve","cartID","metadata","cartItemsSnapshot","JSON","parse","undefined","shippingAddress","Array","isArray","cart","findByID","select","tenant","cartTenant","order","amount","currency","toUpperCase","user","items","status","transactions","timestamp","Date","toISOString","update","purchasedAt","message","orderID","transactionID","error","logger"],"mappings":"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"}