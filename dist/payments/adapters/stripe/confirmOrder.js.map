{"version":3,"sources":["../../../../src/payments/adapters/stripe/confirmOrder.ts"],"sourcesContent":["import Stripe from 'stripe'\n\nimport type { PaymentAdapter } from '../../../types/index.js'\nimport type { StripeAdapterArgs } from './index.js'\n\ntype Props = {\n\tapiVersion?: Stripe.StripeConfig['apiVersion']\n\tappInfo?: Stripe.StripeConfig['appInfo']\n\tsecretKey: StripeAdapterArgs['secretKey']\n}\n\nexport const confirmOrder: (props: Props) => NonNullable<PaymentAdapter>['confirmOrder'] =\n\t(props) =>\n\tasync ({ data, ordersSlug = 'orders', req, transactionsSlug = 'transactions' }) => {\n\t\tconst payload = req.payload\n\t\tconst { apiVersion, appInfo, secretKey } = props || {}\n\n\t\tconst customerEmail = data.customerEmail\n\t\tconst paymentIntentID = data.paymentIntentID as string\n\n\t\tif (!paymentIntentID) {\n\t\t\tthrow new Error('PaymentIntent ID is required')\n\t\t}\n\n\t\t// Find our existing transaction by the payment intent ID\n\t\tconst transactionsResults = await payload.find({\n\t\t\tcollection: transactionsSlug,\n\t\t\twhere: {\n\t\t\t\t'stripe.paymentIntentID': {\n\t\t\t\t\tequals: paymentIntentID,\n\t\t\t\t},\n\t\t\t},\n\t\t})\n\n\t\tconst transaction = transactionsResults.docs[0]\n\n\t\tif (!transactionsResults.totalDocs || !transaction) {\n\t\t\tthrow new Error('No transaction found for the provided PaymentIntent ID')\n\t\t}\n\n\t\tlet resolvedSecretKey = secretKey\n\t\tif (typeof secretKey === 'function') {\n\t\t\t// @ts-expect-error - injecting tenant context for resolver\n\t\t\treq.tenant = transaction.tenant\n\t\t\tresolvedSecretKey = await secretKey({ req })\n\t\t}\n\n\t\tif (!resolvedSecretKey) {\n\t\t\tthrow new Error('Stripe secret key is required')\n\t\t}\n\n\t\tconst stripe = new Stripe(resolvedSecretKey as string, {\n\t\t\t// API version can only be the latest, stripe recommends ts ignoring it\n\t\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n\t\t\t// @ts-ignore - ignoring since possible versions are not type safe, only the latest version is recognised\n\t\t\tapiVersion: apiVersion || '2025-09-30.clover',\n\t\t\tappInfo: appInfo || {\n\t\t\t\tname: 'Stripe Payload Plugin',\n\t\t\t\turl: 'https://payloadcms.com',\n\t\t\t},\n\t\t})\n\n\t\t// Verify the payment intent exists and retrieve it\n\t\tconst paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentID)\n\n\t\tconst cartID = paymentIntent.metadata.cartID\n\t\tconst cartItemsSnapshot = paymentIntent.metadata.cartItemsSnapshot ? JSON.parse(paymentIntent.metadata.cartItemsSnapshot) : undefined\n\n\t\tconst shippingAddress = paymentIntent.metadata.shippingAddress ? JSON.parse(paymentIntent.metadata.shippingAddress) : undefined\n\n\t\tif (!cartID) {\n\t\t\tthrow new Error('Cart ID not found in the PaymentIntent metadata')\n\t\t}\n\n\t\tif (!cartItemsSnapshot || !Array.isArray(cartItemsSnapshot)) {\n\t\t\tthrow new Error('Cart items snapshot not found or invalid in the PaymentIntent metadata')\n\t\t}\n\n\t\t// Fetch the cart to get the tenant (needed for multi-tenant support)\n\t\tconst cart = await payload.findByID({\n\t\t\tcollection: 'carts',\n\t\t\tid: cartID,\n\t\t\tselect: {\n\t\t\t\tid: true,\n\t\t\t\ttenant: true,\n\t\t\t},\n\t\t})\n\n\t\tif (!cart) {\n\t\t\tthrow new Error(`Cart with ID ${cartID} not found`)\n\t\t}\n\n\t\t// Extract tenant from cart for multi-tenant support\n\t\t// @ts-expect-error - tenant field may be added by multi-tenant plugin\n\t\tconst cartTenant = typeof cart.tenant === 'object' ? cart.tenant?.id : cart.tenant\n\n\t\tif (!cartTenant) {\n\t\t\tthrow new Error(`Cart ${cartID} has no tenant assigned`)\n\t\t}\n\n\t\tconst order = await payload.create({\n\t\t\tcollection: ordersSlug,\n\t\t\tdata: {\n\t\t\t\tamount: paymentIntent.amount,\n\t\t\t\tcurrency: paymentIntent.currency.toUpperCase(),\n\t\t\t\t...(req.user ? { customer: req.user.id } : { customerEmail }),\n\t\t\t\titems: cartItemsSnapshot,\n\t\t\t\tshippingAddress,\n\t\t\t\tstatus: 'processing',\n\t\t\t\ttransactions: [transaction.id],\n\t\t\t\ttenant: cartTenant,\n\t\t\t},\n\t\t})\n\n\t\tconst timestamp = new Date().toISOString()\n\n\t\tawait payload.update({\n\t\t\tid: cartID,\n\t\t\tcollection: 'carts',\n\t\t\tdata: {\n\t\t\t\tpurchasedAt: timestamp,\n\t\t\t},\n\t\t})\n\n\t\tawait payload.update({\n\t\t\tid: transaction.id,\n\t\t\tcollection: transactionsSlug,\n\t\t\tdata: {\n\t\t\t\torder: order.id,\n\t\t\t\tstatus: 'succeeded',\n\t\t\t},\n\t\t})\n\n\t\treturn {\n\t\t\tmessage: 'Payment initiated successfully',\n\t\t\torderID: order.id,\n\t\t\ttransactionID: transaction.id,\n\t\t}\n\t}\n"],"names":["Stripe","confirmOrder","props","data","ordersSlug","req","transactionsSlug","payload","apiVersion","appInfo","secretKey","customerEmail","paymentIntentID","Error","transactionsResults","find","collection","where","equals","transaction","docs","totalDocs","resolvedSecretKey","tenant","stripe","name","url","paymentIntent","paymentIntents","retrieve","cartID","metadata","cartItemsSnapshot","JSON","parse","undefined","shippingAddress","Array","isArray","cart","findByID","id","select","cartTenant","order","create","amount","currency","toUpperCase","user","customer","items","status","transactions","timestamp","Date","toISOString","update","purchasedAt","message","orderID","transactionID"],"mappings":"AAAA,OAAOA,YAAY,SAAQ;AAW3B,OAAO,MAAMC,eACZ,CAACC,QACD,OAAO,EAAEC,IAAI,EAAEC,aAAa,QAAQ,EAAEC,GAAG,EAAEC,mBAAmB,cAAc,EAAE;QAC7E,MAAMC,UAAUF,IAAIE,OAAO;QAC3B,MAAM,EAAEC,UAAU,EAAEC,OAAO,EAAEC,SAAS,EAAE,GAAGR,SAAS,CAAC;QAErD,MAAMS,gBAAgBR,KAAKQ,aAAa;QACxC,MAAMC,kBAAkBT,KAAKS,eAAe;QAE5C,IAAI,CAACA,iBAAiB;YACrB,MAAM,IAAIC,MAAM;QACjB;QAEA,yDAAyD;QACzD,MAAMC,sBAAsB,MAAMP,QAAQQ,IAAI,CAAC;YAC9CC,YAAYV;YACZW,OAAO;gBACN,0BAA0B;oBACzBC,QAAQN;gBACT;YACD;QACD;QAEA,MAAMO,cAAcL,oBAAoBM,IAAI,CAAC,EAAE;QAE/C,IAAI,CAACN,oBAAoBO,SAAS,IAAI,CAACF,aAAa;YACnD,MAAM,IAAIN,MAAM;QACjB;QAEA,IAAIS,oBAAoBZ;QACxB,IAAI,OAAOA,cAAc,YAAY;YACpC,2DAA2D;YAC3DL,IAAIkB,MAAM,GAAGJ,YAAYI,MAAM;YAC/BD,oBAAoB,MAAMZ,UAAU;gBAAEL;YAAI;QAC3C;QAEA,IAAI,CAACiB,mBAAmB;YACvB,MAAM,IAAIT,MAAM;QACjB;QAEA,MAAMW,SAAS,IAAIxB,OAAOsB,mBAA6B;YACtD,uEAAuE;YACvE,6DAA6D;YAC7D,yGAAyG;YACzGd,YAAYA,cAAc;YAC1BC,SAASA,WAAW;gBACnBgB,MAAM;gBACNC,KAAK;YACN;QACD;QAEA,mDAAmD;QACnD,MAAMC,gBAAgB,MAAMH,OAAOI,cAAc,CAACC,QAAQ,CAACjB;QAE3D,MAAMkB,SAASH,cAAcI,QAAQ,CAACD,MAAM;QAC5C,MAAME,oBAAoBL,cAAcI,QAAQ,CAACC,iBAAiB,GAAGC,KAAKC,KAAK,CAACP,cAAcI,QAAQ,CAACC,iBAAiB,IAAIG;QAE5H,MAAMC,kBAAkBT,cAAcI,QAAQ,CAACK,eAAe,GAAGH,KAAKC,KAAK,CAACP,cAAcI,QAAQ,CAACK,eAAe,IAAID;QAEtH,IAAI,CAACL,QAAQ;YACZ,MAAM,IAAIjB,MAAM;QACjB;QAEA,IAAI,CAACmB,qBAAqB,CAACK,MAAMC,OAAO,CAACN,oBAAoB;YAC5D,MAAM,IAAInB,MAAM;QACjB;QAEA,qEAAqE;QACrE,MAAM0B,OAAO,MAAMhC,QAAQiC,QAAQ,CAAC;YACnCxB,YAAY;YACZyB,IAAIX;YACJY,QAAQ;gBACPD,IAAI;gBACJlB,QAAQ;YACT;QACD;QAEA,IAAI,CAACgB,MAAM;YACV,MAAM,IAAI1B,MAAM,CAAC,aAAa,EAAEiB,OAAO,UAAU,CAAC;QACnD;QAEA,oDAAoD;QACpD,sEAAsE;QACtE,MAAMa,aAAa,OAAOJ,KAAKhB,MAAM,KAAK,WAAWgB,KAAKhB,MAAM,EAAEkB,KAAKF,KAAKhB,MAAM;QAElF,IAAI,CAACoB,YAAY;YAChB,MAAM,IAAI9B,MAAM,CAAC,KAAK,EAAEiB,OAAO,uBAAuB,CAAC;QACxD;QAEA,MAAMc,QAAQ,MAAMrC,QAAQsC,MAAM,CAAC;YAClC7B,YAAYZ;YACZD,MAAM;gBACL2C,QAAQnB,cAAcmB,MAAM;gBAC5BC,UAAUpB,cAAcoB,QAAQ,CAACC,WAAW;gBAC5C,GAAI3C,IAAI4C,IAAI,GAAG;oBAAEC,UAAU7C,IAAI4C,IAAI,CAACR,EAAE;gBAAC,IAAI;oBAAE9B;gBAAc,CAAC;gBAC5DwC,OAAOnB;gBACPI;gBACAgB,QAAQ;gBACRC,cAAc;oBAAClC,YAAYsB,EAAE;iBAAC;gBAC9BlB,QAAQoB;YACT;QACD;QAEA,MAAMW,YAAY,IAAIC,OAAOC,WAAW;QAExC,MAAMjD,QAAQkD,MAAM,CAAC;YACpBhB,IAAIX;YACJd,YAAY;YACZb,MAAM;gBACLuD,aAAaJ;YACd;QACD;QAEA,MAAM/C,QAAQkD,MAAM,CAAC;YACpBhB,IAAItB,YAAYsB,EAAE;YAClBzB,YAAYV;YACZH,MAAM;gBACLyC,OAAOA,MAAMH,EAAE;gBACfW,QAAQ;YACT;QACD;QAEA,OAAO;YACNO,SAAS;YACTC,SAAShB,MAAMH,EAAE;YACjBoB,eAAe1C,YAAYsB,EAAE;QAC9B;IACD,EAAC"}