{"version":3,"sources":["../../../../src/payments/adapters/stripe/confirmOrder.ts"],"sourcesContent":["import Stripe from 'stripe'\n\nimport type { PaymentAdapter } from '../../../types/index.js'\nimport type { StripeAdapterArgs } from './index.js'\n\ntype Props = {\n  apiVersion?: Stripe.StripeConfig['apiVersion']\n  appInfo?: Stripe.StripeConfig['appInfo']\n  secretKey: StripeAdapterArgs['secretKey']\n}\n\nexport const confirmOrder: (props: Props) => NonNullable<PaymentAdapter>['confirmOrder'] =\n  (props) =>\n  async ({ data, ordersSlug = 'orders', req, transactionsSlug = 'transactions' }) => {\n    const payload = req.payload\n    const { apiVersion, appInfo, secretKey } = props || {}\n\n    const customerEmail = data.customerEmail\n\n    const paymentIntentID = data.paymentIntentID as string\n\n    if (!secretKey) {\n      throw new Error('Stripe secret key is required')\n    }\n\n    if (!paymentIntentID) {\n      throw new Error('PaymentIntent ID is required')\n    }\n\n    const stripe = new Stripe(secretKey, {\n      // API version can only be the latest, stripe recommends ts ignoring it\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore - ignoring since possible versions are not type safe, only the latest version is recognised\n      apiVersion: apiVersion || '2025-09-30.clover',\n      appInfo: appInfo || {\n        name: 'Stripe Payload Plugin',\n        url: 'https://payloadcms.com',\n      },\n    })\n\n    try {\n      let customer = (\n        await stripe.customers.list({\n          email: customerEmail,\n        })\n      ).data[0]\n\n      if (!customer?.id) {\n        customer = await stripe.customers.create({\n          email: customerEmail,\n        })\n      }\n\n      // Find our existing transaction by the payment intent ID\n      const transactionsResults = await payload.find({\n        collection: transactionsSlug,\n        where: {\n          'stripe.paymentIntentID': {\n            equals: paymentIntentID,\n          },\n        },\n      })\n\n      const transaction = transactionsResults.docs[0]\n\n      if (!transactionsResults.totalDocs || !transaction) {\n        throw new Error('No transaction found for the provided PaymentIntent ID')\n      }\n\n      // Verify the payment intent exists and retrieve it\n      const paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentID)\n\n      const cartID = paymentIntent.metadata.cartID\n      const cartItemsSnapshot = paymentIntent.metadata.cartItemsSnapshot\n        ? JSON.parse(paymentIntent.metadata.cartItemsSnapshot)\n        : undefined\n\n      const shippingAddress = paymentIntent.metadata.shippingAddress\n        ? JSON.parse(paymentIntent.metadata.shippingAddress)\n        : undefined\n\n      if (!cartID) {\n        throw new Error('Cart ID not found in the PaymentIntent metadata')\n      }\n\n      if (!cartItemsSnapshot || !Array.isArray(cartItemsSnapshot)) {\n        throw new Error('Cart items snapshot not found or invalid in the PaymentIntent metadata')\n      }\n\n      // Extract tenant from transaction for multi-tenant support\n      const transactionTenant =\n        typeof transaction.tenant === 'object' ? transaction.tenant?.id : transaction.tenant\n\n      const order = await payload.create({\n        collection: ordersSlug,\n        data: {\n          amount: paymentIntent.amount,\n          currency: paymentIntent.currency.toUpperCase(),\n          ...(req.user ? { customer: req.user.id } : { customerEmail }),\n          items: cartItemsSnapshot,\n          shippingAddress,\n          status: 'processing',\n          transactions: [transaction.id],\n          ...(transactionTenant && { tenant: transactionTenant }),\n        },\n      })\n\n      const timestamp = new Date().toISOString()\n\n      await payload.update({\n        id: cartID,\n        collection: 'carts',\n        overrideAccess: true,\n        data: {\n          purchasedAt: timestamp,\n        },\n      })\n\n      await payload.update({\n        id: transaction.id,\n        collection: transactionsSlug,\n        data: {\n          order: order.id,\n          status: 'succeeded',\n        },\n      })\n\n      return {\n        message: 'Payment initiated successfully',\n        orderID: order.id,\n        transactionID: transaction.id,\n      }\n    } catch (error) {\n      console.log(error)\n      payload.logger.error(error, 'Error initiating payment with Stripe')\n\n      throw new Error(error instanceof Error ? error.message : 'Unknown error initiating payment')\n    }\n  }\n"],"names":["Stripe","confirmOrder","props","data","ordersSlug","req","transactionsSlug","payload","apiVersion","appInfo","secretKey","customerEmail","paymentIntentID","Error","stripe","name","url","customer","customers","list","email","id","create","transactionsResults","find","collection","where","equals","transaction","docs","totalDocs","paymentIntent","paymentIntents","retrieve","cartID","metadata","cartItemsSnapshot","JSON","parse","undefined","shippingAddress","Array","isArray","transactionTenant","tenant","order","amount","currency","toUpperCase","user","items","status","transactions","timestamp","Date","toISOString","update","overrideAccess","purchasedAt","message","orderID","transactionID","error","console","log","logger"],"mappings":"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"}