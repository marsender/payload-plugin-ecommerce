{"version":3,"sources":["../../../../src/payments/adapters/stripe/index.ts"],"sourcesContent":["import type { Field, GroupField, PayloadRequest } from 'payload'\nimport type { Stripe } from 'stripe'\n\nimport type { PaymentAdapter, PaymentAdapterArgs, PaymentAdapterClient, PaymentAdapterClientArgs } from '../../../types/index.js'\n\nimport { confirmOrder } from './confirmOrder.js'\nimport { webhooksEndpoint } from './endpoints/webhooks.js'\nimport { initiatePayment } from './initiatePayment.js'\n\ntype StripeWebhookHandler = (args: { event: Stripe.Event; req: PayloadRequest; stripe: Stripe }) => Promise<void> | void\n\ntype StripeWebhookHandlers = {\n\t/**\n\t * Description of the event (e.g., invoice.created or charge.refunded).\n\t */\n\t[webhookName: string]: StripeWebhookHandler\n}\n\n/**\n * Arguments for resolving the Stripe Connect account ID from cart data.\n * Used when payments need to be routed to different connected accounts.\n */\nexport type ResolveConnectedAccountArgs = {\n\tcart: import('../../../types/index.js').Cart\n\treq: PayloadRequest\n}\n\n/**\n * Function type for resolving the Stripe Connect account ID.\n * Should return the connected account ID (e.g., 'acct_1234xyz') or undefined if no connected account should be used.\n */\nexport type ResolveConnectedAccountFn = (args: ResolveConnectedAccountArgs) => Promise<string | undefined> | string | undefined\n\nexport type StripeKeyResolver = (args: { req: PayloadRequest }) => Promise<string> | string\n\nexport type StripeAdapterArgs = {\n\t/**\n\t * This library's types only reflect the latest API version.\n\t *\n\t * We recommend upgrading your account's API Version to the latest version\n\t * if you wish to use TypeScript with this library.\n\t *\n\t * If you wish to remain on your account's default API version,\n\t * you may pass `null` or another version instead of the latest version,\n\t * and add a `@ts-ignore` comment here and anywhere the types differ between API versions.\n\t *\n\t * @docs https://stripe.com/docs/api/versioning\n\t */\n\tapiVersion?: Stripe.StripeConfig['apiVersion']\n\tappInfo?: Stripe.StripeConfig['appInfo']\n\tpublishableKey: string | StripeKeyResolver\n\tsecretKey: string | StripeKeyResolver\n\twebhooks?: StripeWebhookHandlers\n\twebhookSecret?: string | StripeKeyResolver\n\t/**\n\t * Optional function to resolve the Stripe Connect account ID from the cart.\n\t * When provided, payments will be routed to the connected account using `transfer_data`.\n\t * This is useful for marketplace scenarios where different sellers/coaches have their own Stripe accounts.\n\t *\n\t * @example\n\t * ```ts\n\t * resolveConnectedAccount: async ({ cart, req }) => {\n\t *   // Get the first product's coach and return their Stripe Connect account ID\n\t *   const product = await req.payload.findByID({\n\t *     collection: 'products',\n\t *     id: cart.items[0].product,\n\t *     depth: 1,\n\t *   })\n\t *   return product.coach?.stripeConnectAccountId\n\t * }\n\t * ```\n\t */\n\tresolveConnectedAccount?: ResolveConnectedAccountFn\n} & PaymentAdapterArgs\n\nexport const stripeAdapter: (props: StripeAdapterArgs) => PaymentAdapter = (props) => {\n\tconst { apiVersion, appInfo, groupOverrides, resolveConnectedAccount, secretKey, webhooks, webhookSecret } = props\n\tconst label = props?.label || 'Stripe'\n\n\tconst baseFields: Field[] = [\n\t\t{\n\t\t\tname: 'customerID',\n\t\t\ttype: 'text',\n\t\t\tlabel: 'Stripe Customer ID',\n\t\t},\n\t\t{\n\t\t\tname: 'paymentIntentID',\n\t\t\ttype: 'text',\n\t\t\tlabel: 'Stripe PaymentIntent ID',\n\t\t},\n\t\t{\n\t\t\tname: 'connectedAccountId',\n\t\t\ttype: 'text',\n\t\t\tlabel: 'Stripe Connected Account ID',\n\t\t\tadmin: {\n\t\t\t\tdescription: 'The Stripe Connected Account ID that received this payment (for Stripe Connect)',\n\t\t\t},\n\t\t},\n\t]\n\n\tconst groupField: GroupField = {\n\t\tname: 'stripe',\n\t\ttype: 'group',\n\t\t...groupOverrides,\n\t\tadmin: {\n\t\t\tcondition: (data) => {\n\t\t\t\tconst path = 'paymentMethod'\n\n\t\t\t\treturn data?.[path] === 'stripe'\n\t\t\t},\n\t\t\t...groupOverrides?.admin,\n\t\t},\n\t\tfields: groupOverrides?.fields && typeof groupOverrides?.fields === 'function' ? groupOverrides.fields({ defaultFields: baseFields }) : baseFields,\n\t}\n\n\treturn {\n\t\tname: 'stripe',\n\t\tconfirmOrder: confirmOrder({\n\t\t\tapiVersion,\n\t\t\tappInfo,\n\t\t\tsecretKey,\n\t\t}),\n\t\tendpoints: [webhooksEndpoint({ apiVersion, appInfo, secretKey, webhooks, webhookSecret })],\n\t\tgroup: groupField,\n\t\tinitiatePayment: initiatePayment({\n\t\t\tapiVersion,\n\t\t\tappInfo,\n\t\t\tresolveConnectedAccount,\n\t\t\tsecretKey,\n\t\t}),\n\t\tlabel,\n\t}\n}\n\nexport type StripeAdapterClientArgs = {\n\t/**\n\t * This library's types only reflect the latest API version.\n\t *\n\t * We recommend upgrading your account's API Version to the latest version\n\t * if you wish to use TypeScript with this library.\n\t *\n\t * If you wish to remain on your account's default API version,\n\t * you may pass `null` or another version instead of the latest version,\n\t * and add a `@ts-ignore` comment here and anywhere the types differ between API versions.\n\t *\n\t * @docs https://stripe.com/docs/api/versioning\n\t */\n\tapiVersion?: Stripe.StripeConfig['apiVersion']\n\tappInfo?: Stripe.StripeConfig['appInfo']\n\t/**\n\t * @deprecated The publishable key is not used by stripeAdapterClient.\n\t * For multi-tenant apps, fetch it dynamically from tenant settings.\n\t */\n\tpublishableKey?: string\n} & PaymentAdapterClientArgs\n\nexport const stripeAdapterClient: (props?: StripeAdapterClientArgs) => PaymentAdapterClient = (props) => {\n\treturn {\n\t\tname: 'stripe',\n\t\tconfirmOrder: true,\n\t\tinitiatePayment: true,\n\t\tlabel: props?.label || 'Card',\n\t}\n}\n\nexport type InitiatePaymentReturnType = {\n\tclientSecret: string\n\tmessage: string\n\tpaymentIntentID: string\n}\n"],"names":["confirmOrder","webhooksEndpoint","initiatePayment","stripeAdapter","props","apiVersion","appInfo","groupOverrides","resolveConnectedAccount","secretKey","webhooks","webhookSecret","label","baseFields","name","type","admin","description","groupField","condition","data","path","fields","defaultFields","endpoints","group","stripeAdapterClient"],"mappings":"AAKA,SAASA,YAAY,QAAQ,oBAAmB;AAChD,SAASC,gBAAgB,QAAQ,0BAAyB;AAC1D,SAASC,eAAe,QAAQ,uBAAsB;AAoEtD,OAAO,MAAMC,gBAA8D,CAACC;IAC3E,MAAM,EAAEC,UAAU,EAAEC,OAAO,EAAEC,cAAc,EAAEC,uBAAuB,EAAEC,SAAS,EAAEC,QAAQ,EAAEC,aAAa,EAAE,GAAGP;IAC7G,MAAMQ,QAAQR,OAAOQ,SAAS;IAE9B,MAAMC,aAAsB;QAC3B;YACCC,MAAM;YACNC,MAAM;YACNH,OAAO;QACR;QACA;YACCE,MAAM;YACNC,MAAM;YACNH,OAAO;QACR;QACA;YACCE,MAAM;YACNC,MAAM;YACNH,OAAO;YACPI,OAAO;gBACNC,aAAa;YACd;QACD;KACA;IAED,MAAMC,aAAyB;QAC9BJ,MAAM;QACNC,MAAM;QACN,GAAGR,cAAc;QACjBS,OAAO;YACNG,WAAW,CAACC;gBACX,MAAMC,OAAO;gBAEb,OAAOD,MAAM,CAACC,KAAK,KAAK;YACzB;YACA,GAAGd,gBAAgBS,KAAK;QACzB;QACAM,QAAQf,gBAAgBe,UAAU,OAAOf,gBAAgBe,WAAW,aAAaf,eAAee,MAAM,CAAC;YAAEC,eAAeV;QAAW,KAAKA;IACzI;IAEA,OAAO;QACNC,MAAM;QACNd,cAAcA,aAAa;YAC1BK;YACAC;YACAG;QACD;QACAe,WAAW;YAACvB,iBAAiB;gBAAEI;gBAAYC;gBAASG;gBAAWC;gBAAUC;YAAc;SAAG;QAC1Fc,OAAOP;QACPhB,iBAAiBA,gBAAgB;YAChCG;YACAC;YACAE;YACAC;QACD;QACAG;IACD;AACD,EAAC;AAwBD,OAAO,MAAMc,sBAAiF,CAACtB;IAC9F,OAAO;QACNU,MAAM;QACNd,cAAc;QACdE,iBAAiB;QACjBU,OAAOR,OAAOQ,SAAS;IACxB;AACD,EAAC"}