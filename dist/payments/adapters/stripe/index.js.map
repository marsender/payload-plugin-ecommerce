{"version":3,"sources":["../../../../src/payments/adapters/stripe/index.ts"],"sourcesContent":["import type { Field, GroupField, PayloadRequest } from 'payload'\nimport type { Stripe } from 'stripe'\n\nimport type {\n  PaymentAdapter,\n  PaymentAdapterArgs,\n  PaymentAdapterClient,\n  PaymentAdapterClientArgs,\n} from '../../../types/index.js'\n\nimport { confirmOrder } from './confirmOrder.js'\nimport { webhooksEndpoint } from './endpoints/webhooks.js'\nimport { initiatePayment } from './initiatePayment.js'\n\ntype StripeWebhookHandler = (args: {\n  event: Stripe.Event\n  req: PayloadRequest\n  stripe: Stripe\n}) => Promise<void> | void\n\ntype StripeWebhookHandlers = {\n  /**\n   * Description of the event (e.g., invoice.created or charge.refunded).\n   */\n  [webhookName: string]: StripeWebhookHandler\n}\n\n/**\n * Arguments for resolving the Stripe Connect account ID from cart data.\n * Used when payments need to be routed to different connected accounts.\n */\nexport type ResolveConnectedAccountArgs = {\n  cart: import('../../../types/index.js').Cart\n  req: PayloadRequest\n}\n\n/**\n * Function type for resolving the Stripe Connect account ID.\n * Should return the connected account ID (e.g., 'acct_1234xyz') or undefined if no connected account should be used.\n */\nexport type ResolveConnectedAccountFn = (\n  args: ResolveConnectedAccountArgs,\n) => Promise<string | undefined> | string | undefined\n\nexport type StripeAdapterArgs = {\n  /**\n   * This library's types only reflect the latest API version.\n   *\n   * We recommend upgrading your account's API Version to the latest version\n   * if you wish to use TypeScript with this library.\n   *\n   * If you wish to remain on your account's default API version,\n   * you may pass `null` or another version instead of the latest version,\n   * and add a `@ts-ignore` comment here and anywhere the types differ between API versions.\n   *\n   * @docs https://stripe.com/docs/api/versioning\n   */\n  apiVersion?: Stripe.StripeConfig['apiVersion']\n  appInfo?: Stripe.StripeConfig['appInfo']\n  publishableKey: string\n  secretKey: string\n  webhooks?: StripeWebhookHandlers\n  webhookSecret?: string\n  /**\n   * Optional function to resolve the Stripe Connect account ID from the cart.\n   * When provided, payments will be routed to the connected account using `transfer_data`.\n   * This is useful for marketplace scenarios where different sellers/coaches have their own Stripe accounts.\n   *\n   * @example\n   * ```ts\n   * resolveConnectedAccount: async ({ cart, req }) => {\n   *   // Get the first product's coach and return their Stripe Connect account ID\n   *   const product = await req.payload.findByID({\n   *     collection: 'products',\n   *     id: cart.items[0].product,\n   *     depth: 1,\n   *   })\n   *   return product.coach?.stripeConnectAccountId\n   * }\n   * ```\n   */\n  resolveConnectedAccount?: ResolveConnectedAccountFn\n} & PaymentAdapterArgs\n\nexport const stripeAdapter: (props: StripeAdapterArgs) => PaymentAdapter = (props) => {\n  const {\n    apiVersion,\n    appInfo,\n    groupOverrides,\n    resolveConnectedAccount,\n    secretKey,\n    webhooks,\n    webhookSecret,\n  } = props\n  const label = props?.label || 'Stripe'\n\n  const baseFields: Field[] = [\n    {\n      name: 'customerID',\n      type: 'text',\n      label: 'Stripe Customer ID',\n    },\n    {\n      name: 'paymentIntentID',\n      type: 'text',\n      label: 'Stripe PaymentIntent ID',\n    },\n    {\n      name: 'connectedAccountId',\n      type: 'text',\n      label: 'Stripe Connected Account ID',\n      admin: {\n        description:\n          'The Stripe Connected Account ID that received this payment (for Stripe Connect)',\n      },\n    },\n  ]\n\n  const groupField: GroupField = {\n    name: 'stripe',\n    type: 'group',\n    ...groupOverrides,\n    admin: {\n      condition: (data) => {\n        const path = 'paymentMethod'\n\n        return data?.[path] === 'stripe'\n      },\n      ...groupOverrides?.admin,\n    },\n    fields:\n      groupOverrides?.fields && typeof groupOverrides?.fields === 'function'\n        ? groupOverrides.fields({ defaultFields: baseFields })\n        : baseFields,\n  }\n\n  return {\n    name: 'stripe',\n    confirmOrder: confirmOrder({\n      apiVersion,\n      appInfo,\n      secretKey,\n    }),\n    endpoints: [webhooksEndpoint({ apiVersion, appInfo, secretKey, webhooks, webhookSecret })],\n    group: groupField,\n    initiatePayment: initiatePayment({\n      apiVersion,\n      appInfo,\n      resolveConnectedAccount,\n      secretKey,\n    }),\n    label,\n  }\n}\n\nexport type StripeAdapterClientArgs = {\n  /**\n   * This library's types only reflect the latest API version.\n   *\n   * We recommend upgrading your account's API Version to the latest version\n   * if you wish to use TypeScript with this library.\n   *\n   * If you wish to remain on your account's default API version,\n   * you may pass `null` or another version instead of the latest version,\n   * and add a `@ts-ignore` comment here and anywhere the types differ between API versions.\n   *\n   * @docs https://stripe.com/docs/api/versioning\n   */\n  apiVersion?: Stripe.StripeConfig['apiVersion']\n  appInfo?: Stripe.StripeConfig['appInfo']\n  publishableKey: string\n} & PaymentAdapterClientArgs\n\nexport const stripeAdapterClient: (props: StripeAdapterClientArgs) => PaymentAdapterClient = (\n  props,\n) => {\n  return {\n    name: 'stripe',\n    confirmOrder: true,\n    initiatePayment: true,\n    label: 'Card',\n  }\n}\n\nexport type InitiatePaymentReturnType = {\n  clientSecret: string\n  message: string\n  paymentIntentID: string\n}\n"],"names":["confirmOrder","webhooksEndpoint","initiatePayment","stripeAdapter","props","apiVersion","appInfo","groupOverrides","resolveConnectedAccount","secretKey","webhooks","webhookSecret","label","baseFields","name","type","admin","description","groupField","condition","data","path","fields","defaultFields","endpoints","group","stripeAdapterClient"],"mappings":"AAUA,SAASA,YAAY,QAAQ,oBAAmB;AAChD,SAASC,gBAAgB,QAAQ,0BAAyB;AAC1D,SAASC,eAAe,QAAQ,uBAAsB;AAwEtD,OAAO,MAAMC,gBAA8D,CAACC;IAC1E,MAAM,EACJC,UAAU,EACVC,OAAO,EACPC,cAAc,EACdC,uBAAuB,EACvBC,SAAS,EACTC,QAAQ,EACRC,aAAa,EACd,GAAGP;IACJ,MAAMQ,QAAQR,OAAOQ,SAAS;IAE9B,MAAMC,aAAsB;QAC1B;YACEC,MAAM;YACNC,MAAM;YACNH,OAAO;QACT;QACA;YACEE,MAAM;YACNC,MAAM;YACNH,OAAO;QACT;QACA;YACEE,MAAM;YACNC,MAAM;YACNH,OAAO;YACPI,OAAO;gBACLC,aACE;YACJ;QACF;KACD;IAED,MAAMC,aAAyB;QAC7BJ,MAAM;QACNC,MAAM;QACN,GAAGR,cAAc;QACjBS,OAAO;YACLG,WAAW,CAACC;gBACV,MAAMC,OAAO;gBAEb,OAAOD,MAAM,CAACC,KAAK,KAAK;YAC1B;YACA,GAAGd,gBAAgBS,KAAK;QAC1B;QACAM,QACEf,gBAAgBe,UAAU,OAAOf,gBAAgBe,WAAW,aACxDf,eAAee,MAAM,CAAC;YAAEC,eAAeV;QAAW,KAClDA;IACR;IAEA,OAAO;QACLC,MAAM;QACNd,cAAcA,aAAa;YACzBK;YACAC;YACAG;QACF;QACAe,WAAW;YAACvB,iBAAiB;gBAAEI;gBAAYC;gBAASG;gBAAWC;gBAAUC;YAAc;SAAG;QAC1Fc,OAAOP;QACPhB,iBAAiBA,gBAAgB;YAC/BG;YACAC;YACAE;YACAC;QACF;QACAG;IACF;AACF,EAAC;AAoBD,OAAO,MAAMc,sBAAgF,CAC3FtB;IAEA,OAAO;QACLU,MAAM;QACNd,cAAc;QACdE,iBAAiB;QACjBU,OAAO;IACT;AACF,EAAC"}